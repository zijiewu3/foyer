

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>simtk.openmm.app.forcefield &mdash; foyer 0.6.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../../',
              VERSION:'0.6.2',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> foyer
          

          
          </a>

          
            
            
              <div class="version">
                0.6.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../smarts.html">SMARTS-based atomtyping</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../forcefields.html">Parameter definitions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../atom-typing_options.html">Atom-typing Options</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage_examples.html">Usage Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../paper_examples.html">Paper Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../validation.html">Validation of force field files</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../citing_foyer.html">Citing foyer</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">foyer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>simtk.openmm.app.forcefield</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for simtk.openmm.app.forcefield</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">forcefield.py: Constructs OpenMM System objects based on a Topology and an XML force field description</span>

<span class="sd">This is part of the OpenMM molecular simulation toolkit originating from</span>
<span class="sd">Simbios, the NIH National Center for Physics-Based Simulation of</span>
<span class="sd">Biological Structures at Stanford, funded under the NIH Roadmap for</span>
<span class="sd">Medical Research, grant U54 GM072970. See https://simtk.org.</span>

<span class="sd">Portions copyright (c) 2012-2018 Stanford University and the Authors.</span>
<span class="sd">Authors: Peter Eastman, Mark Friedrichs</span>
<span class="sd">Contributors:</span>

<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="sd">copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="sd">to deal in the Software without restriction, including without limitation</span>
<span class="sd">the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="sd">and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="sd">Software is furnished to do so, subject to the following conditions:</span>

<span class="sd">The above copyright notice and this permission notice shall be included in</span>
<span class="sd">all copies or substantial portions of the Software.</span>

<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</span>
<span class="sd">THE AUTHORS, CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<span class="sd">DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<span class="sd">OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<span class="sd">USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Peter Eastman&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">etree</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">cos</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">heapq</span> <span class="k">import</span> <span class="n">heappush</span><span class="p">,</span> <span class="n">heappop</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">simtk.openmm</span> <span class="k">as</span> <span class="nn">mm</span>
<span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="k">as</span> <span class="nn">unit</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">element</span> <span class="k">as</span> <span class="n">elem</span>
<span class="kn">from</span> <span class="nn">simtk.openmm.app</span> <span class="k">import</span> <span class="n">Topology</span>
<span class="kn">from</span> <span class="nn">simtk.openmm.app.internal.singleton</span> <span class="k">import</span> <span class="n">Singleton</span>

<span class="c1"># Directories from which to load built in force fields.</span>

<span class="n">_dataDirectories</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_getDataDirectories</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_dataDirectories</span>
    <span class="k">if</span> <span class="n">_dataDirectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_dataDirectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;data&#39;</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="k">import</span> <span class="n">iter_entry_points</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;openmm.forcefielddir&#39;</span><span class="p">):</span>
                <span class="n">_dataDirectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">load</span><span class="p">()())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># pkg_resources is not installed</span>
    <span class="k">return</span> <span class="n">_dataDirectories</span>

<span class="k">def</span> <span class="nf">_convertParameterToNumber</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">bar</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">param</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">bar</span>
        <span class="k">return</span> <span class="n">param</span><span class="o">.</span><span class="n">value_in_unit_system</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">md_unit_system</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_parseFunctions</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the attributes on an XML tag to find any tabulated functions it defines.&quot;&quot;&quot;</span>
    <span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Function&#39;</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">functionType</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">functionType</span> <span class="o">=</span> <span class="s1">&#39;Continuous1D&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">function</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">functionType</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">functions</span>

<span class="k">def</span> <span class="nf">_createFunctions</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add TabulatedFunctions to a Force based on the information that was recorded by _parseFunctions().&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous1D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous1DFunction</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous2D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous3D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zsize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete1D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete1DFunction</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete2D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete3D&#39;</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zsize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">))</span>

<span class="c1"># Enumerated values for nonbonded method</span>

<span class="k">class</span> <span class="nc">NoCutoff</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;NoCutoff&#39;</span>
<span class="n">NoCutoff</span> <span class="o">=</span> <span class="n">NoCutoff</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CutoffNonPeriodic</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;CutoffNonPeriodic&#39;</span>
<span class="n">CutoffNonPeriodic</span> <span class="o">=</span> <span class="n">CutoffNonPeriodic</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CutoffPeriodic</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;CutoffPeriodic&#39;</span>
<span class="n">CutoffPeriodic</span> <span class="o">=</span> <span class="n">CutoffPeriodic</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Ewald</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Ewald&#39;</span>
<span class="n">Ewald</span> <span class="o">=</span> <span class="n">Ewald</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PME</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;PME&#39;</span>
<span class="n">PME</span> <span class="o">=</span> <span class="n">PME</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">LJPME</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;LJPME&#39;</span>
<span class="n">LJPME</span> <span class="o">=</span> <span class="n">LJPME</span><span class="p">()</span>

<span class="c1"># Enumerated values for constraint type</span>

<span class="k">class</span> <span class="nc">HBonds</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;HBonds&#39;</span>
<span class="n">HBonds</span> <span class="o">=</span> <span class="n">HBonds</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">AllBonds</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;AllBonds&#39;</span>
<span class="n">AllBonds</span> <span class="o">=</span> <span class="n">AllBonds</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">HAngles</span><span class="p">(</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;HAngles&#39;</span>
<span class="n">HAngles</span> <span class="o">=</span> <span class="n">HAngles</span><span class="p">()</span>

<span class="c1"># A map of functions to parse elements of the XML file.</span>

<span class="n">parsers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">ForceField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A ForceField constructs OpenMM System objects based on a Topology.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load one or more XML files and create a ForceField object based on them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list</span>
<span class="sd">            A list of XML files defining the force field.  Each entry may</span>
<span class="sd">            be an absolute file path, a path relative to the current working</span>
<span class="sd">            directory, a path relative to this module&#39;s data subdirectory</span>
<span class="sd">            (for built in force fields), or an open file-like object with a</span>
<span class="sd">            read() method from which the forcefield XML data can be loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templatePatches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="nb">set</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templateGenerators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadFile</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loadFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load an XML file and add the definitions from it to this ForceField.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : string or file or tuple</span>
<span class="sd">            An XML file or tuple of XML files containing force field definitions.</span>
<span class="sd">            Each entry may be either an absolute file path, a path relative to the current working</span>
<span class="sd">            directory, a path relative to this module&#39;s data subdirectory (for</span>
<span class="sd">            built in force fields), or an open file-like object with a read()</span>
<span class="sd">            method from which the forcefield XML data can be loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>

        <span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># this handles either filenames or open file-like objects</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dataDir</span> <span class="ow">in</span> <span class="n">_getDataDirectories</span><span class="p">():</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Fail with an error message about which file could not be read.</span>
                <span class="c1"># TODO: Also handle case where fallback to &#39;data&#39; directory encounters problems,</span>
                <span class="c1"># but this is much less worrisome because we control those files.</span>
                <span class="n">msg</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;ForceField.loadFile() encountered an error reading file &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not locate file &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

            <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Process includes in this file.</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">parentDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parentDir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Include&#39;</span><span class="p">):</span>
                <span class="n">includeFile</span> <span class="o">=</span> <span class="n">include</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
                <span class="n">joined</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">includeFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">joined</span><span class="p">):</span>
                    <span class="n">includeFile</span> <span class="o">=</span> <span class="n">joined</span>
                <span class="k">if</span> <span class="n">includeFile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">includeFile</span><span class="p">)</span>

        <span class="c1"># Load the atom types.</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;AtomTypes&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;AtomTypes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registerAtomType</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>

        <span class="c1"># Load the residue templates.</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Residues&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Residues&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Residue&#39;</span><span class="p">):</span>
                    <span class="n">resName</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateData</span><span class="p">(</span><span class="n">resName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;override&#39;</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">overrideLevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">])</span>
                    <span class="n">atomIndices</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Atom&#39;</span><span class="p">):</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">):</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">atomName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">atomName</span> <span class="ow">in</span> <span class="n">atomIndices</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Residue &#39;</span><span class="o">+</span><span class="n">resName</span><span class="o">+</span><span class="s1">&#39; contains multiple atoms named &#39;</span><span class="o">+</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">atomIndices</span><span class="p">[</span><span class="n">atomName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                        <span class="n">typeName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atomName</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">[</span><span class="n">typeName</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;VirtualSite&#39;</span><span class="p">):</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">virtualSites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_VirtualSiteData</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">atomIndices</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Bond&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;atomName1&#39;</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">addBondByName</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName1&#39;</span><span class="p">],</span> <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName2&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ExternalBond&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;atomName&#39;</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">addExternalBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;AllowPatch&#39;</span><span class="p">):</span>
                        <span class="n">patchName</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">patchName</span><span class="p">:</span>
                            <span class="n">colonIndex</span> <span class="o">=</span> <span class="n">patchName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">resName</span><span class="p">,</span> <span class="n">patchName</span><span class="p">[:</span><span class="n">colonIndex</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">patchName</span><span class="p">[</span><span class="n">colonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">resName</span><span class="p">,</span> <span class="n">patchName</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registerResidueTemplate</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="c1"># Load the patch defintions.</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Patches&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Patches&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Patch&#39;</span><span class="p">):</span>
                    <span class="n">patchName</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;residues&#39;</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="n">numResidues</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;residues&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">numResidues</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">patchData</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchData</span><span class="p">(</span><span class="n">patchName</span><span class="p">,</span> <span class="n">numResidues</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;AddAtom&#39;</span><span class="p">):</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">):</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">atomName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">atomName</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Patch &#39;</span><span class="o">+</span><span class="n">patchName</span><span class="o">+</span><span class="s1">&#39; contains multiple atoms named &#39;</span><span class="o">+</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">typeName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">addedAtoms</span><span class="p">[</span><span class="n">atomDescription</span><span class="o">.</span><span class="n">residue</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atomDescription</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">[</span><span class="n">typeName</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ChangeAtom&#39;</span><span class="p">):</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">):</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">atomName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">atomName</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Patch &#39;</span><span class="o">+</span><span class="n">patchName</span><span class="o">+</span><span class="s1">&#39; contains multiple atoms named &#39;</span><span class="o">+</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">typeName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">changedAtoms</span><span class="p">[</span><span class="n">atomDescription</span><span class="o">.</span><span class="n">residue</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atomDescription</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">[</span><span class="n">typeName</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;RemoveAtom&#39;</span><span class="p">):</span>
                        <span class="n">atomName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">atomName</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Patch &#39;</span><span class="o">+</span><span class="n">patchName</span><span class="o">+</span><span class="s1">&#39; contains multiple atoms named &#39;</span><span class="o">+</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomDescription</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;AddBond&#39;</span><span class="p">):</span>
                        <span class="n">atom1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName1&#39;</span><span class="p">])</span>
                        <span class="n">atom2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName2&#39;</span><span class="p">])</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">addedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;RemoveBond&#39;</span><span class="p">):</span>
                        <span class="n">atom1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName1&#39;</span><span class="p">])</span>
                        <span class="n">atom2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName2&#39;</span><span class="p">])</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">deletedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;AddExternalBond&#39;</span><span class="p">):</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName&#39;</span><span class="p">])</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">addedExternalBonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;RemoveExternalBond&#39;</span><span class="p">):</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName&#39;</span><span class="p">])</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">deletedExternalBonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ApplyToResidue&#39;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                            <span class="n">colonIndex</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">colonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">patchName</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="n">colonIndex</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">patchName</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registerPatch</span><span class="p">(</span><span class="n">patchData</span><span class="p">)</span>

        <span class="c1"># Load force definitions</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">parsers</span><span class="p">:</span>
                    <span class="n">parsers</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">](</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Load scripts</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Script&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registerScript</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getGenerators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of all registered generators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span>

    <span class="k">def</span> <span class="nf">registerGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new generator.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerAtomType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new atom type.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found multiple definitions for atom type: &#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
        <span class="n">atomClass</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">])</span>
        <span class="n">element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;element&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">get_by_symbol</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomType</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">atomClass</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atomClass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">:</span>
            <span class="n">typeSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="n">atomClass</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typeSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="n">atomClass</span><span class="p">]</span> <span class="o">=</span> <span class="n">typeSet</span>
        <span class="n">typeSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerResidueTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new residue template.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">:</span>
            <span class="c1"># There is already a template with this name, so check the override levels.</span>

            <span class="n">existingTemplate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">overrideLevel</span> <span class="o">&lt;</span> <span class="n">existingTemplate</span><span class="o">.</span><span class="n">overrideLevel</span><span class="p">:</span>
                <span class="c1"># The existing one takes precedence, so just return.</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">overrideLevel</span> <span class="o">&gt;</span> <span class="n">existingTemplate</span><span class="o">.</span><span class="n">overrideLevel</span><span class="p">:</span>
                <span class="c1"># We need to delete the existing template.</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">existingSignature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">existingTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span><span class="p">[</span><span class="n">existingSignature</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">existingTemplate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Residue template </span><span class="si">%s</span><span class="s1"> with the same override level </span><span class="si">%d</span><span class="s1"> already exists.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">overrideLevel</span><span class="p">))</span>

        <span class="c1"># Register the template.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">template</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">registerPatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new patch that can be applied to templates.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span><span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span>

    <span class="k">def</span> <span class="nf">registerTemplatePatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">patchResidueIndex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register that a particular patch can be used with a particular residue.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">[</span><span class="n">residue</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">[</span><span class="n">residue</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">patch</span><span class="p">,</span> <span class="n">patchResidueIndex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">registerScript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new script to be executed after building the System.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerTemplateGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a residue template generator that can be used to parameterize residues that do not match existing forcefield templates.</span>

<span class="sd">        This functionality can be used to add handlers to parameterize small molecules or unnatural/modified residues.</span>

<span class="sd">        .. CAUTION:: This method is experimental, and its API is subject to change.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        generator : function</span>
<span class="sd">            A function that will be called when a residue is encountered that does not match an existing forcefield template.</span>

<span class="sd">        When a residue without a template is encountered, the ``generator`` function is called with:</span>

<span class="sd">        ::</span>
<span class="sd">           success = generator(forcefield, residue)</span>

<span class="sd">        where ``forcefield`` is the calling ``ForceField`` object and ``residue`` is a simtk.openmm.app.topology.Residue object.</span>

<span class="sd">        ``generator`` must conform to the following API:</span>

<span class="sd">        ::</span>
<span class="sd">           generator API</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           forcefield : simtk.openmm.app.ForceField</span>
<span class="sd">               The ForceField object to which residue templates and/or parameters are to be added.</span>
<span class="sd">           residue : simtk.openmm.app.Topology.Residue</span>
<span class="sd">               The residue topology for which a template is to be generated.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           success : bool</span>
<span class="sd">               If the generator is able to successfully parameterize the residue, `True` is returned.</span>
<span class="sd">               If the generator cannot parameterize the residue, it should return `False` and not modify `forcefield`.</span>

<span class="sd">           The generator should either register a residue template directly with `forcefield.registerResidueTemplate(template)`</span>
<span class="sd">           or it should call `forcefield.loadFile(file)` to load residue definitions from an ffxml file.</span>

<span class="sd">           It can also use the `ForceField` programmatic API to add additional atom types (via `forcefield.registerAtomType(parameters)`)</span>
<span class="sd">           or additional parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_templateGenerators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_findAtomTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the attributes on an XML tag to find the set of atom types for each atom it involves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrib : dict of attributes</span>
<span class="sd">            The dictionary of attributes for an XML parameter tag.</span>
<span class="sd">        num : int</span>
<span class="sd">            The number of atom specifiers (e.g. &#39;class1&#39; through &#39;class4&#39;) to extract.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        types : list</span>
<span class="sd">            A list of atom types that match.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">classAttrib</span> <span class="o">=</span> <span class="s1">&#39;class&#39;</span><span class="o">+</span><span class="n">suffix</span>
            <span class="n">typeAttrib</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span><span class="o">+</span><span class="n">suffix</span>
            <span class="k">if</span> <span class="n">classAttrib</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">typeAttrib</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified both a type and a class for the same atom: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">attrib</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">attrib</span><span class="p">[</span><span class="n">classAttrib</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># Unknown atom class</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="n">attrib</span><span class="p">[</span><span class="n">classAttrib</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">typeAttrib</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrib</span><span class="p">[</span><span class="n">typeAttrib</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">attrib</span><span class="p">[</span><span class="n">typeAttrib</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># Unknown atom type</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">attrib</span><span class="p">[</span><span class="n">typeAttrib</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># Unknown atom type</span>
        <span class="k">return</span> <span class="n">types</span>

    <span class="k">def</span> <span class="nf">_parseTorsion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the node defining a torsion.&quot;&quot;&quot;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">torsion</span> <span class="o">=</span> <span class="n">PeriodicTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="s1">&#39;phase</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
            <span class="n">torsion</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;periodicity</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span><span class="p">]))</span>
            <span class="n">torsion</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;phase</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span><span class="p">]))</span>
            <span class="n">torsion</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">index</span><span class="p">]))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">torsion</span>

    <span class="k">class</span> <span class="nc">_SystemData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about the system being created.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomType</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomParameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomTemplateIndexes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excludeAtomWith</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtualSites</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isAngleConstrained</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">addConstraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add a constraint to the system, avoiding duplicate constraints.&quot;&quot;&quot;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Two constraints were specified between atoms </span><span class="si">%d</span><span class="s1"> and </span><span class="si">%d</span><span class="s1"> with different distances&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">recordMatchedAtomParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Record parameters for atoms based on having matched a residue to a template.&quot;&quot;&quot;</span>
            <span class="n">matchAtoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">(),</span> <span class="n">matches</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">match</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atomParameters</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">match</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="p">[</span><span class="n">matchAtoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">],</span> <span class="n">matchAtoms</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">excludeWith</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">_TemplateData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about a residue template definition.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtualSites</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">externalBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overrideLevel</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">getAtomIndexByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Look up an atom index by atom name, providing a helpful error message if not found.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atom_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">index</span>

            <span class="c1"># Provide a helpful error message if atom name not found.</span>
            <span class="n">msg</span> <span class="o">=</span>  <span class="s2">&quot;Atom name &#39;</span><span class="si">%s</span><span class="s2">&#39; not found in residue template &#39;</span><span class="si">%s</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Possible atom names are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add a bond between two atoms in a template given their indices in the template.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">bondedTo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">bondedTo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addBondByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1_name</span><span class="p">,</span> <span class="n">atom2_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add a bond between two atoms in a template given their atom names.&quot;&quot;&quot;</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAtomIndexByName</span><span class="p">(</span><span class="n">atom1_name</span><span class="p">)</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAtomIndexByName</span><span class="p">(</span><span class="n">atom2_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addExternalBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_index</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Designate that an atom in a residue template has an external bond, using atom index within template.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">externalBonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span><span class="o">.</span><span class="n">externalBonds</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">addExternalBondByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Designate that an atom in a residue template has an external bond, using atom name within template.&quot;&quot;&quot;</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAtomIndexByName</span><span class="p">(</span><span class="n">atom_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addExternalBond</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">_TemplateAtomData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about an atom in a residue template definition.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{}):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bondedTo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">externalBonds</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">class</span> <span class="nc">_BondData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about a bond.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atom1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atom2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isConstrained</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">class</span> <span class="nc">_VirtualSiteData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about a virtual site.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">atomIndices</span><span class="p">):</span>
            <span class="n">attrib</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;average2&#39;</span><span class="p">:</span>
                <span class="n">numAtoms</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight1&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight2&#39;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;average3&#39;</span><span class="p">:</span>
                <span class="n">numAtoms</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight1&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight2&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight3&#39;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;outOfPlane&#39;</span><span class="p">:</span>
                <span class="n">numAtoms</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight12&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weight13&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;weightCross&#39;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;localCoords&#39;</span><span class="p">:</span>
                <span class="n">numAtoms</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">originWeights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xWeights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yWeights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="p">(</span><span class="s1">&#39;wo</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numAtoms</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                    <span class="n">numAtoms</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">originWeights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;wo</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">numAtoms</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xWeights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;wx</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">numAtoms</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">yWeights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;wy</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">numAtoms</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">localPos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown virtual site type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;siteName&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">atomIndices</span><span class="p">[</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;siteName&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomIndices</span><span class="p">[</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atomName</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;atom</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s1">&#39;excludeWith&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">excludeWith</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;excludeWith&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">excludeWith</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">_PatchData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about a patch definition.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">numResidues</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numResidues</span> <span class="o">=</span> <span class="n">numResidues</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addedAtoms</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numResidues</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changedAtoms</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numResidues</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletedAtoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addedBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletedBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addedExternalBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletedExternalBonds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allAtomNames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">createPatchedTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templates</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Apply this patch to a set of templates, creating new modified ones.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numResidues</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Patch &#39;</span><span class="si">%s</span><span class="s2">&#39; expected </span><span class="si">%d</span><span class="s2"> templates, received </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numResidues</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)))</span>

            <span class="c1"># Construct a new version of each template.</span>

            <span class="n">newTemplates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templates</span><span class="p">):</span>
                <span class="n">newTemplate</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateData</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">newTemplates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newTemplate</span><span class="p">)</span>

                <span class="c1"># Build the list of atoms in it.</span>

                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">deleted</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">deleted</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span> <span class="k">for</span> <span class="n">deleted</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="p">):</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addedAtoms</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">newTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Patch &#39;</span><span class="si">%s</span><span class="s2">&#39; adds an atom with the same name as an existing atom: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">newTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
                <span class="n">oldAtomIndex</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">)])</span>
                <span class="n">newAtomIndex</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedAtoms</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newAtomIndex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Patch &#39;</span><span class="si">%s</span><span class="s2">&#39; modifies nonexistent atom &#39;</span><span class="si">%s</span><span class="s2">&#39; in template &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">newTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">newAtomIndex</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

                <span class="c1"># Copy over the virtual sites, translating the atom indices.</span>

                <span class="n">indexMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">oldAtomIndex</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">newAtomIndex</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">newAtomIndex</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">oldAtomIndex</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">indexMap</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">indexMap</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                        <span class="n">newSite</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                        <span class="n">newSite</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">indexMap</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">newSite</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">indexMap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">virtualSites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSite</span><span class="p">)</span>

                <span class="c1"># Build the lists of bonds and external bonds.</span>

                <span class="n">atomMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">indexMap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexMap</span><span class="p">])</span>
                <span class="n">deletedBonds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletedBonds</span> <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom1</span><span class="p">]</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">atomMap</span> <span class="ow">and</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">atomMap</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deletedBonds</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deletedBonds</span><span class="p">:</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">atomMap</span><span class="p">[</span><span class="n">a1</span><span class="p">],</span> <span class="n">atomMap</span><span class="p">[</span><span class="n">a2</span><span class="p">])</span>
                <span class="n">deletedExternalBonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletedExternalBonds</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">externalBonds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deletedExternalBonds</span><span class="p">:</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">addExternalBond</span><span class="p">(</span><span class="n">indexMap</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addedBonds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">addBondByName</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                        <span class="n">newTemplate</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addedExternalBonds</span><span class="p">:</span>
                    <span class="n">newTemplate</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newTemplates</span>

    <span class="k">class</span> <span class="nc">_PatchAtomData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to encapsulate data about an atom in a patch definition.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">colonIndex</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">description</span><span class="p">[:</span><span class="n">colonIndex</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">description</span><span class="p">[</span><span class="n">colonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">description</span>

    <span class="k">class</span> <span class="nc">_AtomType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to record atom types and associated properties.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atomClass</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomClass</span> <span class="o">=</span> <span class="n">atomClass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>

    <span class="k">class</span> <span class="nc">_AtomTypeParameters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inner class used to record parameter values for atom types.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">forceName</span><span class="p">,</span> <span class="n">atomTag</span><span class="p">,</span> <span class="n">paramNames</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceName</span> <span class="o">=</span> <span class="n">forceName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomTag</span> <span class="o">=</span> <span class="n">atomTag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span> <span class="o">=</span> <span class="n">paramNames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramsForType</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraParamsForType</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">registerAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">expectedParams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">expectedParams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expectedParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span>
            <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">extraValues</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expectedParams</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">extraValues</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">expectedParams</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expectedParams</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: No value specified for &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">paramsForType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extraParamsForType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">extraValues</span>

        <span class="k">def</span> <span class="nf">parseDefinitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;&quot;Load the definitions from an XML element.&quot;&quot;&quot;</span>
            <span class="n">expectedParams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span><span class="p">)</span>
            <span class="n">excludedParams</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;UseAttributeFromResidue&#39;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">excludedParams</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expectedParams</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: &lt;UseAttributeFromResidue&gt; specified an invalid attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
                <span class="n">expectedParams</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomTag</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">excludedParams</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: The attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; appeared in both &lt;</span><span class="si">%s</span><span class="s1">&gt; and &lt;UseAttributeFromResidue&gt; tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomTag</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registerAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">expectedParams</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">getAtomParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Get the parameter values for a particular atom.&quot;&quot;&quot;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomParameters</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsForType</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsForType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramNames</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: No value specified for &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: No parameters defined for atom type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">getExtraParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Get extra parameter values for an atom that appeared in the &lt;Atom&gt; tag but were not included in paramNames.&quot;&quot;&quot;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramsForType</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraParamsForType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: No parameters defined for atom type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceName</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_getResidueTemplateMatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">templateSignatures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the residue template matches, or None if none are found.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res : Topology.Residue</span>
<span class="sd">            The residue for which template matches are to be retrieved.</span>
<span class="sd">        bondedToAtom : list of set of int</span>
<span class="sd">            bondedToAtom[i] is the set of atoms bonded to atom index i</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        template : _ForceFieldTemplate</span>
<span class="sd">            The matching forcefield residue template, or None if no matches are found.</span>
<span class="sd">        matches : list</span>
<span class="sd">            a list specifying which atom of the template each atom of the residue</span>
<span class="sd">            corresponds to, or None if it does not match the template</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">templateSignatures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">templateSignatures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">()])</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">:</span>
            <span class="n">allMatches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">_matchResidue</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">allMatches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Multiple matching templates found for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">): </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">allMatches</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_buildBondedToAtomList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a list of which atom indices are bonded to each atom.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            The Topology whose bonds are to be indexed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bondedToAtom : list of set of int</span>
<span class="sd">            bondedToAtom[index] is the set of atom indices bonded to atom `index`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bondedToAtom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
            <span class="n">bondedToAtom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bondedToAtom</span>

    <span class="k">def</span> <span class="nf">getUnmatchedResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of Residue objects from specified topology for which no forcefield templates are available.</span>

<span class="sd">        .. CAUTION:: This method is experimental, and its API is subject to change.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            The Topology whose residues are to be checked against the forcefield residue templates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unmatched_residues : list of Residue</span>
<span class="sd">            List of Residue objects from `topology` for which no forcefield residue templates are available.</span>
<span class="sd">            Note that multiple instances of the same residue appearing at different points in the topology may be returned.</span>

<span class="sd">        This method may be of use in generating missing residue templates or diagnosing parameterization failures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the template matching each residue, compiling a list of residues for which no templates are available.</span>
        <span class="n">bondedToAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildBondedToAtomList</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
        <span class="n">unmatched_residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="c1"># list of unmatched residues</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">():</span>
            <span class="c1"># Attempt to match one of the existing templates.</span>
            <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># No existing templates match.</span>
                <span class="n">unmatched_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unmatched_residues</span>

    <span class="k">def</span> <span class="nf">getMatchingTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of forcefield residue templates matching residues in the specified topology.</span>

<span class="sd">        .. CAUTION:: This method is experimental, and its API is subject to change.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            The Topology whose residues are to be checked against the forcefield residue templates.</span>
<span class="sd">        ignoreExternalBonds : bool=False</span>
<span class="sd">            If true, ignore external bonds when matching residues to templates.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        templates : list of _TemplateData</span>
<span class="sd">            List of forcefield residue templates corresponding to residues in the topology.</span>
<span class="sd">            templates[index] is template corresponding to residue `index` in topology.residues()</span>

<span class="sd">        This method may be of use in debugging issues related to parameter assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the template matching each residue, compiling a list of residues for which no templates are available.</span>
        <span class="n">bondedToAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildBondedToAtomList</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="c1"># list of templates matching the corresponding residues</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">():</span>
            <span class="c1"># Attempt to match one of the existing templates.</span>
            <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="n">ignoreExternalBonds</span><span class="p">)</span>
            <span class="c1"># Raise an exception if we have found no templates that match.</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No template found for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">).  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_findMatchErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">templates</span>

    <span class="k">def</span> <span class="nf">generateTemplatesForUnmatchedResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate forcefield residue templates for residues in specified topology for which no forcefield templates are available.</span>

<span class="sd">        .. CAUTION:: This method is experimental, and its API is subject to change.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            The Topology whose residues are to be checked against the forcefield residue templates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        templates : list of _TemplateData</span>
<span class="sd">            List of forcefield residue templates corresponding to residues in `topology` for which no forcefield templates are currently available.</span>
<span class="sd">            Atom types will be set to `None`, but template name, atom names, elements, and connectivity will be taken from corresponding Residue objects.</span>
<span class="sd">        residues : list of Residue</span>
<span class="sd">            List of Residue objects that were used to generate the templates.</span>
<span class="sd">            `residues[index]` is the Residue that was used to generate the template `templates[index]`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get a non-unique list of unmatched residues.</span>
        <span class="n">unmatched_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUnmatchedResidues</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
        <span class="c1"># Generate a unique list of unmatched residues by comparing fingerprints.</span>
        <span class="n">bondedToAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildBondedToAtomList</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
        <span class="n">unique_unmatched_residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="c1"># list of unique unmatched Residue objects from topology</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="c1"># corresponding _TemplateData templates</span>
        <span class="n">signatures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">unmatched_residues</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="p">])</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">_createResidueTemplate</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
            <span class="n">is_unique</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">signatures</span><span class="p">:</span>
                <span class="c1"># Signature is the same as an existing residue; check connectivity.</span>
                <span class="k">for</span> <span class="n">check_residue</span> <span class="ow">in</span> <span class="n">unique_unmatched_residues</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">_matchResidue</span><span class="p">(</span><span class="n">check_residue</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">is_unique</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_unique</span><span class="p">:</span>
                <span class="c1"># Residue is unique.</span>
                <span class="n">unique_unmatched_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
                <span class="n">signatures</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
                <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">templates</span><span class="p">,</span> <span class="n">unique_unmatched_residues</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">NoCutoff</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="p">,</span>
                     <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">removeCMMotion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hydrogenMass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">residueTemplates</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
                     <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">switchDistance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flexibleConstraints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an OpenMM System representing a Topology with this force field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : Topology</span>
<span class="sd">            The Topology for which to create a System</span>
<span class="sd">        nonbondedMethod : object=NoCutoff</span>
<span class="sd">            The method to use for nonbonded interactions.  Allowed values are</span>
<span class="sd">            NoCutoff, CutoffNonPeriodic, CutoffPeriodic, Ewald, PME, or LJPME.</span>
<span class="sd">        nonbondedCutoff : distance=1*nanometer</span>
<span class="sd">            The cutoff distance to use for nonbonded interactions</span>
<span class="sd">        constraints : object=None</span>
<span class="sd">            Specifies which bonds and angles should be implemented with constraints.</span>
<span class="sd">            Allowed values are None, HBonds, AllBonds, or HAngles.</span>
<span class="sd">        rigidWater : boolean=True</span>
<span class="sd">            If true, water molecules will be fully rigid regardless of the value</span>
<span class="sd">            passed for the constraints argument</span>
<span class="sd">        removeCMMotion : boolean=True</span>
<span class="sd">            If true, a CMMotionRemover will be added to the System</span>
<span class="sd">        hydrogenMass : mass=None</span>
<span class="sd">            The mass to use for hydrogen atoms bound to heavy atoms.  Any mass</span>
<span class="sd">            added to a hydrogen is subtracted from the heavy atom to keep</span>
<span class="sd">            their total mass the same.</span>
<span class="sd">        residueTemplates : dict=dict()</span>
<span class="sd">            Key: Topology Residue object</span>
<span class="sd">            Value: string, name of _TemplateData residue template object to use for (Key) residue.</span>
<span class="sd">            This allows user to specify which template to apply to particular Residues</span>
<span class="sd">            in the event that multiple matching templates are available (e.g Fe2+ and Fe3+</span>
<span class="sd">            templates in the ForceField for a monoatomic iron ion in the topology).</span>
<span class="sd">        ignoreExternalBonds : boolean=False</span>
<span class="sd">            If true, ignore external bonds when matching residues to templates.  This is</span>
<span class="sd">            useful when the Topology represents one piece of a larger molecule, so chains are</span>
<span class="sd">            not terminated properly.  This option can create ambiguities where multiple</span>
<span class="sd">            templates match the same residue.  If that happens, use the residueTemplates</span>
<span class="sd">            argument to specify which one to use.</span>
<span class="sd">        switchDistance : float=None</span>
<span class="sd">            The distance at which the potential energy switching function is turned on for</span>
<span class="sd">            Lennard-Jones interactions. If this is None, no switching function will be used.</span>
<span class="sd">        flexibleConstraints : boolean=False</span>
<span class="sd">            If True, parameters for constrained degrees of freedom will be added to the System</span>
<span class="sd">        args</span>
<span class="sd">            Arbitrary additional keyword arguments may also be specified.</span>
<span class="sd">            This allows extra parameters to be specified that are specific to</span>
<span class="sd">            particular force fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        system</span>
<span class="sd">            the newly created System</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;switchDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">switchDistance</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexibleConstraints</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_SystemData</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="c1"># Make a list of all bonds</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_BondData</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

        <span class="c1"># Record which atoms are bonded to each other atom</span>

        <span class="n">bondedToAtom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">bondedToAtom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">)):</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">)</span>
            <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Find the template matching each residue and assign atom types.</span>

        <span class="n">unmatchedResidues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residues</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">residueTemplates</span><span class="p">:</span>
                    <span class="n">tname</span> <span class="o">=</span> <span class="n">residueTemplates</span><span class="p">[</span><span class="n">res</span><span class="p">]</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">_matchResidue</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;User-supplied template </span><span class="si">%s</span><span class="s1"> does not match the residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Attempt to match one of the existing templates.</span>
                    <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="n">ignoreExternalBonds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unmatchedResidues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">recordMatchedAtomParameters</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

        <span class="c1"># Try to apply patches to find matches for any unmatched residues.</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmatchedResidues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">unmatchedResidues</span> <span class="o">=</span> <span class="n">_applyPatchesToMatchResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">unmatchedResidues</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>

        <span class="c1"># If we still haven&#39;t found a match for a residue, attempt to use residue template generators to create</span>
        <span class="c1"># new templates (and potentially atom types/parameters).</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">unmatchedResidues</span><span class="p">:</span>
            <span class="c1"># A template might have been generated on an earlier iteration of this loop.</span>
            <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="n">ignoreExternalBonds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Try all generators.</span>
                <span class="k">for</span> <span class="n">generator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateGenerators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
                        <span class="c1"># This generator has registered a new residue template that should match.</span>
                        <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="n">ignoreExternalBonds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># Something went wrong because the generated template does not match the residue signature.</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The residue handler </span><span class="si">%s</span><span class="s1"> indicated it had correctly parameterized residue </span><span class="si">%s</span><span class="s1">, but the generated template did not match the residue signature.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># We successfully generated a residue template.  Break out of the for loop.</span>
                            <span class="k">break</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No template found for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">).  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_findMatchErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">recordMatchedAtomParameters</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

        <span class="c1"># Create the System and add atoms</span>

        <span class="n">sys</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
            <span class="c1"># Look up the atom type name, returning a helpful error message if it cannot be found.</span>
            <span class="k">if</span> <span class="n">atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not identify atom type for atom &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">))</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

            <span class="c1"># Look up the type name in the list of registered atom types, returning a helpful error message if it cannot be found.</span>
            <span class="k">if</span> <span class="n">typename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">:</span>
                <span class="n">msg</span>  <span class="o">=</span> <span class="s2">&quot;Could not find typename &#39;</span><span class="si">%s</span><span class="s2">&#39; for atom &#39;</span><span class="si">%s</span><span class="s2">&#39; in list of known atom types.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">))</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Known atom types are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Add the particle to the OpenMM system.</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomTypes</span><span class="p">[</span><span class="n">typename</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="c1"># Adjust hydrogen masses if requested.</span>

        <span class="k">if</span> <span class="n">hydrogenMass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">hydrogenMass</span><span class="p">):</span>
                <span class="n">hydrogenMass</span> <span class="o">*=</span> <span class="n">unit</span><span class="o">.</span><span class="n">dalton</span>
            <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom2</span><span class="p">,</span> <span class="n">atom1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">transferMass</span> <span class="o">=</span> <span class="n">hydrogenMass</span><span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">setParticleMass</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hydrogenMass</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">setParticleMass</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="n">transferMass</span><span class="p">)</span>

        <span class="c1"># Set periodic boundary conditions.</span>

        <span class="n">boxVectors</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">boxVectors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">(</span><span class="n">boxVectors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxVectors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">boxVectors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NoCutoff</span><span class="p">,</span> <span class="n">CutoffNonPeriodic</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Requested periodic boundary conditions for a Topology that does not specify periodic box dimensions&#39;</span><span class="p">)</span>

        <span class="c1"># Make a list of all unique angles</span>

        <span class="n">uniqueAngles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span> <span class="o">&lt;</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">:</span>
                        <span class="n">uniqueAngles</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uniqueAngles</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span> <span class="o">&gt;</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">:</span>
                        <span class="n">uniqueAngles</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">atom</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uniqueAngles</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">uniqueAngles</span><span class="p">))</span>

        <span class="c1"># Make a list of all unique proper torsions</span>

        <span class="n">uniquePropers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span> <span class="o">&lt;</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">uniquePropers</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uniquePropers</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span> <span class="o">&gt;</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">uniquePropers</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">atom</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uniquePropers</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">propers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">uniquePropers</span><span class="p">))</span>

        <span class="c1"># Make a list of all unique improper torsions</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedToAtom</span><span class="p">)):</span>
            <span class="n">bondedTo</span> <span class="o">=</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondedTo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">bondedTo</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Identify bonds that should be implemented with constraints</span>

        <span class="k">if</span> <span class="n">constraints</span> <span class="o">==</span> <span class="n">AllBonds</span> <span class="ow">or</span> <span class="n">constraints</span> <span class="o">==</span> <span class="n">HAngles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="o">==</span> <span class="n">HBonds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span> <span class="ow">or</span> <span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span>
        <span class="k">if</span> <span class="n">rigidWater</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HOH&#39;</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HOH&#39;</span><span class="p">:</span>
                    <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Identify angles that should be implemented with constraints</span>

        <span class="k">if</span> <span class="n">constraints</span> <span class="o">==</span> <span class="n">HAngles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">atom3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">numH</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span>
                    <span class="n">numH</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">atom3</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span>
                    <span class="n">numH</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numH</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">numH</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">oxygen</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rigidWater</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">)):</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">atom3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HOH&#39;</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HOH&#39;</span> <span class="ow">and</span> <span class="n">atom3</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;HOH&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Add virtual sites</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">:</span>
            <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">excludeWith</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span>
            <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">excludeWith</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;average2&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">TwoParticleAverageSite</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">site</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;average3&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">ThreeParticleAverageSite</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">site</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;outOfPlane&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">OutOfPlaneSite</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">site</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;localCoords&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">LocalCoordinatesSite</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">originWeights</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">xWeights</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">yWeights</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">localPos</span><span class="p">))</span>

        <span class="c1"># Add forces to the System</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">createForce</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">removeCMMotion</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">())</span>

        <span class="c1"># Let force generators do postprocessing</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;postprocessSystem&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">force</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">postprocessSystem</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="c1"># Execute scripts found in the XML files.</span>

        <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scripts</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">sys</span>


<span class="k">def</span> <span class="nf">_findBondsForExclusions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a list of bonds to use when identifying exclusions.&quot;&quot;&quot;</span>
    <span class="n">bondIndices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>

    <span class="c1"># If a virtual site does *not* share exclusions with another atom, add a bond between it and its first parent atom.</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">isVirtualSite</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">excludeWith</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">excludeWith</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

    <span class="c1"># Certain particles, such as lone pairs and Drude particles, share exclusions with a parent atom.</span>
    <span class="c1"># If the parent atom does not interact with an atom, the child particle does not either.</span>

    <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">bondIndices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">child1</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom1</span><span class="p">]:</span>
            <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">child2</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">child2</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
            <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">child2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">]:</span>
            <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bondIndices</span>

<span class="k">def</span> <span class="nf">_countResidueAtoms</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count the number of atoms of each element in a residue.&quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">counts</span>


<span class="k">def</span> <span class="nf">_createResidueSignature</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a signature for a residue based on the elements of the atoms it contains.&quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">_countResidueAtoms</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">counts</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
    <span class="n">sig</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>

    <span class="c1"># Convert it to a string.</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">_matchResidue</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine whether a residue matches a template and return a list of corresponding atoms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    res : Residue</span>
<span class="sd">        The residue to check</span>
<span class="sd">    template : _TemplateData</span>
<span class="sd">        The template to compare it to</span>
<span class="sd">    bondedToAtom : list</span>
<span class="sd">        Enumerates which other atoms each atom is bonded to</span>
<span class="sd">    ignoreExternalBonds : bool</span>
<span class="sd">        If true, ignore external bonds when matching templates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        a list specifying which atom of the template each atom of the residue</span>
<span class="sd">        corresponds to, or None if it does not match the template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
    <span class="n">numAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numAtoms</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Translate from global to local atom indices, and record the bonds for each atom.</span>

    <span class="n">renumberAtoms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">):</span>
        <span class="n">renumberAtoms</span><span class="p">[</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">bondedTo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">externalBonds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">renumberAtoms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">renumberAtoms</span><span class="p">]</span>
        <span class="n">bondedTo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">externalBonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">ignoreExternalBonds</span> <span class="k">else</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">renumberAtoms</span><span class="p">]))</span>

    <span class="c1"># For each unique combination of element and number of bonds, make sure the residue and</span>
    <span class="c1"># template have the same number of atoms.</span>

    <span class="n">residueTypeCount</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondedTo</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">externalBonds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">residueTypeCount</span><span class="p">:</span>
            <span class="n">residueTypeCount</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">residueTypeCount</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">templateTypeCount</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bondedTo</span><span class="p">),</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">ignoreExternalBonds</span> <span class="k">else</span> <span class="n">atom</span><span class="o">.</span><span class="n">externalBonds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templateTypeCount</span><span class="p">:</span>
            <span class="n">templateTypeCount</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">templateTypeCount</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">residueTypeCount</span> <span class="o">!=</span> <span class="n">templateTypeCount</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Identify template atoms that could potentially be matches for each atom.</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">):</span>
        <span class="n">exactNameMatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exactNameMatch</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bondedTo</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondedTo</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreExternalBonds</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">externalBonds</span> <span class="o">!=</span> <span class="n">externalBonds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="c1"># Find an optimal ordering for matching atoms.  This means 1) start with the one that has the fewest options,</span>
    <span class="c1"># and 2) follow with ones that are bonded to an already matched atom.</span>

    <span class="n">searchOrder</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">atomsToOrder</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">))</span>
    <span class="n">efficientAtomSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">efficientAtomHeap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomsToOrder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">efficientAtomSet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fewestNeighbors</span> <span class="o">=</span> <span class="n">numAtoms</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atomsToOrder</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">fewestNeighbors</span><span class="p">:</span>
                    <span class="n">nextAtom</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">fewestNeighbors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nextAtom</span> <span class="o">=</span> <span class="n">heappop</span><span class="p">(</span><span class="n">efficientAtomHeap</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">efficientAtomSet</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nextAtom</span><span class="p">)</span>
        <span class="n">searchOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextAtom</span><span class="p">)</span>
        <span class="n">atomsToOrder</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nextAtom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bondedTo</span><span class="p">[</span><span class="n">nextAtom</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atomsToOrder</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">efficientAtomSet</span><span class="p">:</span>
                    <span class="n">efficientAtomSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">heappush</span><span class="p">(</span><span class="n">efficientAtomHeap</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">inverseSearchOrder</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">numAtoms</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">):</span>
        <span class="n">inverseSearchOrder</span><span class="p">[</span><span class="n">searchOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">bondedTo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">inverseSearchOrder</span><span class="p">[</span><span class="n">bondedTo</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedTo</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">searchOrder</span><span class="p">]</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">searchOrder</span><span class="p">]</span>

    <span class="c1"># Recursively match atoms.</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="n">numAtoms</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hasMatch</span> <span class="o">=</span> <span class="n">numAtoms</span><span class="o">*</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">_findAtomMatches</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">bondedTo</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">hasMatch</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">inverseSearchOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAtoms</span><span class="p">)]</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_getAtomMatchCandidates</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">bondedTo</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a list of template atoms that are potential matches for the next atom.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">bonded</span> <span class="ow">in</span> <span class="n">bondedTo</span><span class="p">[</span><span class="n">position</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">bonded</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">:</span>
            <span class="c1"># This atom is bonded to another one for which we already have a match, so only consider</span>
            <span class="c1"># template atoms that *that* one is bonded to.</span>
            <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">bonded</span><span class="p">]]</span><span class="o">.</span><span class="n">bondedTo</span>
    <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_findAtomMatches</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">bondedTo</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">hasMatch</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is called recursively from inside _matchResidue() to identify matching atoms.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_getAtomMatchCandidates</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">bondedTo</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hasMatch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[</span><span class="n">position</span><span class="p">]:</span>
            <span class="c1"># See if the bonds for this identification are consistent</span>

            <span class="n">allBondsMatch</span> <span class="o">=</span> <span class="nb">all</span><span class="p">((</span><span class="n">bonded</span> <span class="o">&gt;</span> <span class="n">position</span> <span class="ow">or</span> <span class="n">matches</span><span class="p">[</span><span class="n">bonded</span><span class="p">]</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bondedTo</span> <span class="k">for</span> <span class="n">bonded</span> <span class="ow">in</span> <span class="n">bondedTo</span><span class="p">[</span><span class="n">position</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">allBondsMatch</span><span class="p">:</span>
                <span class="c1"># This is a possible match, so try matching the rest of the residue.</span>

                <span class="n">matches</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">hasMatch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">_findAtomMatches</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">bondedTo</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">hasMatch</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">hasMatch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_applyPatchesToMatchResidues</span><span class="p">(</span><span class="n">forcefield</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">residues</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to apply patches to find matches for residues.&quot;&quot;&quot;</span>
    <span class="c1"># Start by creating all templates than can be created by applying a combination of one-residue patches</span>
    <span class="c1"># to a single template.  The number of these is usually not too large, and they often cover a large fraction</span>
    <span class="c1"># of residues.</span>

    <span class="n">patchedTemplateSignatures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">patchedTemplates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">:</span>
            <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">]</span> <span class="k">for</span> <span class="n">patchName</span><span class="p">,</span> <span class="n">patchResidueIndex</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">]</span><span class="o">.</span><span class="n">numResidues</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newTemplates</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">patchedTemplates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newTemplates</span>
                <span class="n">_generatePatchedSingleResidueTemplates</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newTemplates</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">patchedTemplate</span> <span class="ow">in</span> <span class="n">newTemplates</span><span class="p">:</span>
                    <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">patchedTemplate</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">patchedTemplateSignatures</span><span class="p">:</span>
                        <span class="n">patchedTemplateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patchedTemplate</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">patchedTemplateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">patchedTemplate</span><span class="p">]</span>

    <span class="c1"># Now see if any of those templates matches any of the residues.</span>

    <span class="n">unmatchedResidues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
        <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_getResidueTemplateMatches</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">patchedTemplateSignatures</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unmatchedResidues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">recordMatchedAtomParameters</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmatchedResidues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># We need to consider multi-residue patches.  This can easily lead to a combinatorial explosion, so we make a simplifying</span>
    <span class="c1"># assumption: that no residue is affected by more than one multi-residue patch (in addition to any number of single-residue</span>
    <span class="c1"># patches).  Record all multi-residue patches, and the templates they can be applied to.</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">maxPatchSize</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_patches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span><span class="p">)]</span>
            <span class="n">maxPatchSize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxPatchSize</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxPatchSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unmatchedResidues</span> <span class="c1"># There aren&#39;t any multi-residue patches</span>
    <span class="k">for</span> <span class="n">templateName</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">patchName</span><span class="p">,</span> <span class="n">patchResidueIndex</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templatePatches</span><span class="p">[</span><span class="n">templateName</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">patchName</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
                <span class="c1"># The patch should accept this template, *and* all patched versions of it generated above.</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">][</span><span class="n">patchResidueIndex</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">templateName</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">templateName</span> <span class="ow">in</span> <span class="n">patchedTemplates</span><span class="p">:</span>
                    <span class="n">patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">][</span><span class="n">patchResidueIndex</span><span class="p">]</span> <span class="o">+=</span> <span class="n">patchedTemplates</span><span class="p">[</span><span class="n">templateName</span><span class="p">]</span>

    <span class="c1"># Record which unmatched residues are bonded to each other.</span>

    <span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">topology</span>
    <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span> <span class="o">!=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="p">:</span>
            <span class="n">res1</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span>
            <span class="k">if</span> <span class="n">res1</span> <span class="ow">in</span> <span class="n">unmatchedResidues</span> <span class="ow">and</span> <span class="n">res2</span> <span class="ow">in</span> <span class="n">unmatchedResidues</span><span class="p">:</span>
                <span class="n">bond</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
                    <span class="n">bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>

    <span class="c1"># Identify clusters of unmatched residues that are all bonded to each other.  These are the ones we&#39;ll</span>
    <span class="c1"># try to apply multi-residue patches to.</span>

    <span class="n">clusterSize</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">bonds</span>
    <span class="k">while</span> <span class="n">clusterSize</span> <span class="o">&lt;=</span> <span class="n">maxPatchSize</span><span class="p">:</span>
        <span class="c1"># Try to apply patches to clusters of this size.</span>

        <span class="k">for</span> <span class="n">patchName</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span> <span class="o">==</span> <span class="n">clusterSize</span><span class="p">:</span>
                <span class="n">matchedClusters</span> <span class="o">=</span> <span class="n">_matchToMultiResiduePatchedTemplates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">patches</span><span class="p">[</span><span class="n">patchName</span><span class="p">],</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">matchedClusters</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                        <span class="n">unmatchedResidues</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
                <span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bond</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span> <span class="k">if</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">unmatchedResidues</span> <span class="ow">and</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">unmatchedResidues</span><span class="p">)</span>

        <span class="c1"># Now extend the clusters to find ones of the next size up.</span>

        <span class="n">largerClusters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="ow">and</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">newCluster</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cluster</span><span class="o">+</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">largerClusters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newCluster</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cluster</span> <span class="ow">and</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">newCluster</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cluster</span><span class="o">+</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">largerClusters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newCluster</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">largerClusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># There are no clusters of this size or larger</span>
            <span class="k">break</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">largerClusters</span>
        <span class="n">clusterSize</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">unmatchedResidues</span>


<span class="k">def</span> <span class="nf">_generatePatchedSingleResidueTemplates</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">newTemplates</span><span class="p">,</span> <span class="n">alteredAtoms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply all possible combinations of a set of single-residue patches to a template.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alteredAtoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This patch would alter an atom that another patch has already altered,</span>
            <span class="c1"># so don&#39;t apply it.</span>
            <span class="n">patchedTemplate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patchedTemplate</span> <span class="o">=</span> <span class="n">patches</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">createPatchedTemplates</span><span class="p">([</span><span class="n">template</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newTemplates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patchedTemplate</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># This probably means the patch is inconsistent with another one that has already been applied,</span>
        <span class="c1"># so just ignore it.</span>
        <span class="n">patchedTemplate</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Call this function recursively to generate combinations of patches.</span>

    <span class="k">if</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">):</span>
        <span class="n">_generatePatchedSingleResidueTemplates</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newTemplates</span><span class="p">,</span> <span class="n">alteredAtoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patchedTemplate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newAlteredAtoms</span> <span class="o">=</span> <span class="n">alteredAtoms</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">)</span>
            <span class="n">_generatePatchedSingleResidueTemplates</span><span class="p">(</span><span class="n">patchedTemplate</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newTemplates</span><span class="p">,</span> <span class="n">newAlteredAtoms</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_matchToMultiResiduePatchedTemplates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">residueTemplates</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply a multi-residue patch to templates, then try to match them against clusters of residues.&quot;&quot;&quot;</span>
    <span class="n">matchedClusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">selectedTemplates</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span>
    <span class="n">_applyMultiResiduePatch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">residueTemplates</span><span class="p">,</span> <span class="n">selectedTemplates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">matchedClusters</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matchedClusters</span>


<span class="k">def</span> <span class="nf">_applyMultiResiduePatch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">candidateTemplates</span><span class="p">,</span> <span class="n">selectedTemplates</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">matchedClusters</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is called recursively to apply a multi-residue patch to all possible combinations of templates.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">candidateTemplates</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
            <span class="n">selectedTemplates</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span>
            <span class="n">_applyMultiResiduePatch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">candidateTemplates</span><span class="p">,</span> <span class="n">selectedTemplates</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">matchedClusters</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We&#39;re at the deepest level of the recursion.  We&#39;ve selected a template for each residue, so apply the patch,</span>
        <span class="c1"># then try to match it against clusters.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">patchedTemplates</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">createPatchedTemplates</span><span class="p">(</span><span class="n">selectedTemplates</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># This probably means the patch is inconsistent with another one that has already been applied,</span>
            <span class="c1"># so just ignore it.</span>
            <span class="k">raise</span>
            <span class="k">return</span>
        <span class="n">newlyMatchedClusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">residues</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
                <span class="n">residueMatches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">residue</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">patchedTemplates</span><span class="p">):</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">_matchResidue</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">residueMatches</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">residueMatches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">residueMatches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Each residue individually matches.  Now make sure they&#39;re bonded in the correct way.</span>

                    <span class="n">bondsMatch</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">addedBonds</span><span class="p">:</span>
                        <span class="n">res1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">residue</span>
                        <span class="n">res2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">residue</span>
                        <span class="k">if</span> <span class="n">res1</span> <span class="o">!=</span> <span class="n">res2</span><span class="p">:</span>
                            <span class="c1"># The patch adds a bond between residues.  Make sure that bond exists.</span>

                            <span class="n">atoms1</span> <span class="o">=</span> <span class="n">patchedTemplates</span><span class="p">[</span><span class="n">res1</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span>
                            <span class="n">atoms2</span> <span class="o">=</span> <span class="n">patchedTemplates</span><span class="p">[</span><span class="n">res2</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span>
                            <span class="n">index1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms1</span><span class="p">))</span> <span class="k">if</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">residueMatches</span><span class="p">[</span><span class="n">res1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">index2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms2</span><span class="p">))</span> <span class="k">if</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">residueMatches</span><span class="p">[</span><span class="n">res2</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">atom1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">residues</span><span class="p">[</span><span class="n">res1</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">())[</span><span class="n">index1</span><span class="p">]</span>
                            <span class="n">atom2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">residues</span><span class="p">[</span><span class="n">res2</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">())[</span><span class="n">index2</span><span class="p">]</span>
                            <span class="n">bondsMatch</span> <span class="o">&amp;=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">bondedToAtom</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bondsMatch</span><span class="p">:</span>
                        <span class="c1"># We successfully matched the template to the residues.  Record the parameters.</span>
    
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">numResidues</span><span class="p">):</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">recordMatchedAtomParameters</span><span class="p">(</span><span class="n">residues</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">patchedTemplates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">residueMatches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">newlyMatchedClusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="c1"># Record which clusters were successfully matched.</span>

        <span class="n">matchedClusters</span> <span class="o">+=</span> <span class="n">newlyMatchedClusters</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">newlyMatchedClusters</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_findMatchErrors</span><span class="p">(</span><span class="n">forcefield</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to guess why a residue failed to match any template and return an error message.&quot;&quot;&quot;</span>
    <span class="n">residueCounts</span> <span class="o">=</span> <span class="n">_countResidueAtoms</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">()])</span>
    <span class="n">numResidueAtoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">residueCounts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">numResidueHeavyAtoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">residueCounts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">residueCounts</span> <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">))</span>

    <span class="c1"># Loop over templates and see how closely each one might match.</span>

    <span class="n">bestMatchName</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">numBestMatchAtoms</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">numResidueAtoms</span>
    <span class="n">numBestMatchHeavyAtoms</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">numResidueHeavyAtoms</span>
    <span class="k">for</span> <span class="n">templateName</span> <span class="ow">in</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">templateName</span><span class="p">]</span>
        <span class="n">templateCounts</span> <span class="o">=</span> <span class="n">_countResidueAtoms</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

        <span class="c1"># Does the residue have any atoms that clearly aren&#39;t in the template?</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templateCounts</span> <span class="ow">or</span> <span class="n">templateCounts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">residueCounts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">residueCounts</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># If there are too many missing atoms, discard this template.</span>

        <span class="n">numTemplateAtoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">templateCounts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">numTemplateHeavyAtoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">templateCounts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">templateCounts</span> <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">numTemplateAtoms</span> <span class="o">&gt;</span> <span class="n">numBestMatchAtoms</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">numTemplateHeavyAtoms</span> <span class="o">&gt;</span> <span class="n">numBestMatchHeavyAtoms</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># If this template has the same number of missing atoms as our previous best one, look at the name</span>
        <span class="c1"># to decide which one to use.</span>

        <span class="k">if</span> <span class="n">numTemplateAtoms</span> <span class="o">==</span> <span class="n">numBestMatchAtoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bestMatchName</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templateName</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Accept this as our new best match.</span>

        <span class="n">bestMatchName</span> <span class="o">=</span> <span class="n">templateName</span>
        <span class="n">numBestMatchAtoms</span> <span class="o">=</span> <span class="n">numTemplateAtoms</span>
        <span class="n">numBestMatchHeavyAtoms</span> <span class="o">=</span> <span class="n">numTemplateHeavyAtoms</span>
        <span class="n">numBestMatchExtraParticles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>

    <span class="c1"># Return an appropriate error message.</span>

    <span class="k">if</span> <span class="n">numBestMatchAtoms</span> <span class="o">==</span> <span class="n">numResidueAtoms</span><span class="p">:</span>
        <span class="n">chainResidues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">residues</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chainResidues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">chainResidues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">res</span> <span class="o">==</span> <span class="n">chainResidues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;The set of atoms matches </span><span class="si">%s</span><span class="s1">, but the bonds are different.  Perhaps the chain is missing a terminal group?&#39;</span> <span class="o">%</span> <span class="n">bestMatchName</span>
        <span class="k">return</span> <span class="s1">&#39;The set of atoms matches </span><span class="si">%s</span><span class="s1">, but the bonds are different.&#39;</span> <span class="o">%</span> <span class="n">bestMatchName</span>
    <span class="k">if</span> <span class="n">bestMatchName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">numBestMatchHeavyAtoms</span> <span class="o">==</span> <span class="n">numResidueHeavyAtoms</span><span class="p">:</span>
            <span class="n">numResidueExtraParticles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">numResidueExtraParticles</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">numBestMatchExtraParticles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;The set of atoms is similar to </span><span class="si">%s</span><span class="s1">, but it is missing </span><span class="si">%d</span><span class="s1"> hydrogen atoms.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bestMatchName</span><span class="p">,</span> <span class="n">numBestMatchAtoms</span><span class="o">-</span><span class="n">numResidueAtoms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numBestMatchExtraParticles</span><span class="o">-</span><span class="n">numResidueExtraParticles</span> <span class="o">==</span> <span class="n">numBestMatchAtoms</span><span class="o">-</span><span class="n">numResidueAtoms</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;The set of atoms is similar to </span><span class="si">%s</span><span class="s1">, but it is missing </span><span class="si">%d</span><span class="s1"> extra particles.  You can add them with Modeller.addExtraParticles().&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bestMatchName</span><span class="p">,</span> <span class="n">numBestMatchAtoms</span><span class="o">-</span><span class="n">numResidueAtoms</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;The set of atoms is similar to </span><span class="si">%s</span><span class="s1">, but it is missing </span><span class="si">%d</span><span class="s1"> atoms.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bestMatchName</span><span class="p">,</span> <span class="n">numBestMatchAtoms</span><span class="o">-</span><span class="n">numResidueAtoms</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;This might mean your input topology is missing some atoms or bonds, or possibly that you are using the wrong force field.&#39;</span>

<span class="k">def</span> <span class="nf">_createResidueTemplate</span><span class="p">(</span><span class="n">residue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a _TemplateData template from a Residue object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    residue : Residue</span>
<span class="sd">        The Residue from which the template is to be constructed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    template : _TemplateData</span>
<span class="sd">        The residue template, with atom types set to None.</span>

<span class="sd">    This method may be useful in creating new residue templates for residues without templates defined by the ForceField.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateData</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
        <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForceField</span><span class="o">.</span><span class="n">_TemplateAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">internal_bonds</span><span class="p">():</span>
        <span class="n">template</span><span class="o">.</span><span class="n">addBondByName</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">residue_atoms</span> <span class="o">=</span> <span class="p">[</span> <span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">external_bonds</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">residue_atoms</span><span class="p">:</span>
            <span class="n">template</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">residue_atoms</span><span class="p">:</span>
            <span class="n">template</span><span class="o">.</span><span class="n">addExternalBondByName</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">_matchImproper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
    <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
    <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
    <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
    <span class="n">wildcard</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tordef</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
        <span class="n">types1</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types1</span>
        <span class="n">types2</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types2</span>
        <span class="n">types3</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types3</span>
        <span class="n">types4</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types4</span>
        <span class="n">hasWildcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">wildcard</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types1</span><span class="p">,</span> <span class="n">types2</span><span class="p">,</span> <span class="n">types3</span><span class="p">,</span> <span class="n">types4</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hasWildcard</span><span class="p">:</span>
            <span class="c1"># Prefer specific definitions over ones with wildcards</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">t4</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(((</span><span class="n">type2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">type3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">type4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">t3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">t4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tordef</span><span class="o">.</span><span class="n">ordering</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                        <span class="c1"># Workaround to be more consistent with AMBER.  It uses wildcards to define most of its</span>
                        <span class="c1"># impropers, which leaves the ordering ambiguous.  It then follows some bizarre rules</span>
                        <span class="c1"># to pick the order.</span>
                        <span class="n">a1</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">a2</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                        <span class="n">e2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                        <span class="k">if</span> <span class="n">e1</span> <span class="o">==</span> <span class="n">e2</span> <span class="ow">and</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="n">a2</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">e1</span> <span class="o">!=</span> <span class="n">elem</span><span class="o">.</span><span class="n">carbon</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e2</span> <span class="o">==</span> <span class="n">elem</span><span class="o">.</span><span class="n">carbon</span> <span class="ow">or</span> <span class="n">e1</span><span class="o">.</span><span class="n">mass</span> <span class="o">&lt;</span> <span class="n">e2</span><span class="o">.</span><span class="n">mass</span><span class="p">):</span>
                            <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t4</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tordef</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">tordef</span><span class="o">.</span><span class="n">ordering</span> <span class="o">==</span> <span class="s1">&#39;charmm&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">hasWildcard</span><span class="p">:</span>
                            <span class="c1"># Workaround to be more consistent with AMBER.  It uses wildcards to define most of its</span>
                            <span class="c1"># impropers, which leaves the ordering ambiguous.  It then follows some bizarre rules</span>
                            <span class="c1"># to pick the order.</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">a2</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">e1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                            <span class="n">e2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                            <span class="k">if</span> <span class="n">e1</span> <span class="o">==</span> <span class="n">e2</span> <span class="ow">and</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="n">a2</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">e1</span> <span class="o">!=</span> <span class="n">elem</span><span class="o">.</span><span class="n">carbon</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e2</span> <span class="o">==</span> <span class="n">elem</span><span class="o">.</span><span class="n">carbon</span> <span class="ow">or</span> <span class="n">e1</span><span class="o">.</span><span class="n">mass</span> <span class="o">&lt;</span> <span class="n">e2</span><span class="o">.</span><span class="n">mass</span><span class="p">):</span>
                                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t4</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tordef</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># There are no wildcards, so the order is unambiguous.</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t3</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t4</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tordef</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">tordef</span><span class="o">.</span><span class="n">ordering</span> <span class="o">==</span> <span class="s1">&#39;amber&#39;</span><span class="p">:</span>
                        <span class="c1"># topology atom indexes</span>
                        <span class="n">a2</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">a3</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">a4</span> <span class="o">=</span> <span class="n">torsion</span><span class="p">[</span><span class="n">t4</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="c1"># residue indexes</span>
                        <span class="n">r2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">r3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">r4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                        <span class="c1"># template atom indexes</span>
                        <span class="n">ta2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]]</span>
                        <span class="n">ta3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]]</span>
                        <span class="n">ta4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]]</span>
                        <span class="c1"># elements</span>
                        <span class="n">e2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                        <span class="n">e3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                        <span class="n">e4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">element</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&gt;</span> <span class="n">r4</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="n">r4</span> <span class="ow">and</span> <span class="n">ta2</span> <span class="o">&gt;</span> <span class="n">ta4</span><span class="p">)):</span>
                                <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a4</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
                                <span class="n">r2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">r4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">ta2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]]</span>
                                <span class="n">ta4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">t3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r3</span> <span class="o">&gt;</span> <span class="n">r4</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r3</span> <span class="o">==</span> <span class="n">r4</span> <span class="ow">and</span> <span class="n">ta3</span> <span class="o">&gt;</span> <span class="n">ta4</span><span class="p">)):</span>
                                <span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span>
                                <span class="n">r3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">r4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">ta3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]]</span>
                                <span class="n">ta4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&gt;</span> <span class="n">r3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="n">r3</span> <span class="ow">and</span> <span class="n">ta2</span> <span class="o">&gt;</span> <span class="n">ta3</span><span class="p">)):</span>
                                <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">e2</span> <span class="o">==</span> <span class="n">e4</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&gt;</span> <span class="n">r4</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="n">r4</span> <span class="ow">and</span> <span class="n">ta2</span> <span class="o">&gt;</span> <span class="n">ta4</span><span class="p">)):</span>
                                <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a4</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
                                <span class="n">r2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">r4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">ta2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]]</span>
                                <span class="n">ta4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">e3</span> <span class="o">==</span> <span class="n">e4</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r3</span> <span class="o">&gt;</span> <span class="n">r4</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r3</span> <span class="o">==</span> <span class="n">r4</span> <span class="ow">and</span> <span class="n">ta3</span> <span class="o">&gt;</span> <span class="n">ta4</span><span class="p">)):</span>
                                <span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span>
                                <span class="n">r3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">r4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span>
                                <span class="n">ta3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a3</span><span class="p">]]</span>
                                <span class="n">ta4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomTemplateIndexes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">a4</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">r3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="n">r3</span> <span class="ow">and</span> <span class="n">ta2</span> <span class="o">&gt;</span> <span class="n">ta3</span><span class="p">):</span>
                                <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="p">)</span>
                        <span class="k">break</span>
    <span class="k">return</span> <span class="n">match</span>

<span class="c1"># The following classes are generators that know how to create Force subclasses and add them to a System that is being</span>
<span class="c1"># created.  Each generator class must define two methods: 1) a static method that takes an etree Element and a ForceField,</span>
<span class="c1"># and returns the corresponding generator object; 2) a createForce() method that constructs the Force object and adds it</span>
<span class="c1"># to the System.  The static method should be added to the parsers map.</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">HarmonicBondGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A HarmonicBondGenerator constructs a HarmonicBondForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondsForAtomType</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">registerBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForAtomType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForAtomType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">HarmonicBondGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">HarmonicBondGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Bond&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">registerBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondsForAtomType</span><span class="p">[</span><span class="n">type1</span><span class="p">]:</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">bond</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># flexibleConstraints allows us to add parameters even if the DOF is</span>
                        <span class="c1"># constrained</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;HarmonicBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HarmonicBondGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">HarmonicAngleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A HarmonicAngleGenerator constructs a HarmonicAngleForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anglesForAtom2Type</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">registerAngle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anglesForAtom2Type</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">HarmonicAngleGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">HarmonicAngleGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Angle&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">registerAngle</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicAngleForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicAngleForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">isConstrained</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="p">):</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anglesForAtom2Type</span><span class="p">[</span><span class="n">type2</span><span class="p">]:</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">isConstrained</span><span class="p">:</span>
                        <span class="c1"># Find the two bonds that make this angle.</span>

                        <span class="n">bond1</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">bond2</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                            <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                            <span class="k">if</span> <span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">bond1</span> <span class="o">=</span> <span class="n">bond</span>
                            <span class="k">elif</span> <span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                <span class="n">bond2</span> <span class="o">=</span> <span class="n">bond</span>

                        <span class="c1"># Compute the distance between atoms and add a constraint</span>

                        <span class="k">if</span> <span class="n">bond1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bond2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">l1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond1</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
                            <span class="n">l2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond2</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
                            <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">length</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">l1</span><span class="o">*</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">l2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="o">*</span><span class="n">l2</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                                <span class="n">data</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">length</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isConstrained</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;HarmonicAngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HarmonicAngleGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">PeriodicTorsion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A PeriodicTorsion records the information for a periodic torsion definition.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">PeriodicTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A PeriodicTorsionGenerator constructs a PeriodicTorsionForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propersForAtomType</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerProperTorsion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">torsion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_parseTorsion</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torsion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proper</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">torsion</span><span class="o">.</span><span class="n">types2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propersForAtomType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">torsion</span><span class="o">.</span><span class="n">types3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propersForAtomType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registerImproperTorsion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="n">torsion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_parseTorsion</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torsion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;charmm&#39;</span><span class="p">,</span> <span class="s1">&#39;amber&#39;</span><span class="p">]:</span>
                <span class="n">torsion</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">ordering</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal ordering type </span><span class="si">%s</span><span class="s1"> for improper torsion </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">torsion</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">improper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">PeriodicTorsionGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">PeriodicTorsionGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Proper&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">registerProperTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Improper&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;ordering&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">registerImproperTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ordering&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">registerImproperTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wildcard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propers</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propersForAtomType</span><span class="p">[</span><span class="n">type2</span><span class="p">]:</span>
                <span class="n">tordef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proper</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types1</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types2</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types3</span>
                <span class="n">types4</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types4</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">):</span>
                    <span class="n">hasWildcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">wildcard</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types1</span><span class="p">,</span> <span class="n">types2</span><span class="p">,</span> <span class="n">types3</span><span class="p">,</span> <span class="n">types4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span> <span class="c1"># Prefer specific definitions over ones with wildcards</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">tordef</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">phase</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">periodicity</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">phase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">_matchImproper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torsion</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tordef</span><span class="o">.</span><span class="n">phase</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">tordef</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="o">.</span><span class="n">periodicity</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">phase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;PeriodicTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PeriodicTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">RBTorsion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An RBTorsion records the information for a Ryckaert-Bellemans torsion definition.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s1">&#39;charmm&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;charmm&#39;</span><span class="p">,</span> <span class="s1">&#39;amber&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">ordering</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal ordering type </span><span class="si">%s</span><span class="s1"> for RBTorsion (</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">RBTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An RBTorsionGenerator constructs an RBTorsionForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">RBTorsionGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">RBTorsionGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Proper&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">proper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RBTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]))</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Improper&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;ordering&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">improper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RBTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ordering&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">improper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RBTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]))</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">RBTorsionForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">RBTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wildcard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propers</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tordef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proper</span><span class="p">:</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types1</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types2</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types3</span>
                <span class="n">types4</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types4</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">):</span>
                    <span class="n">hasWildcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">wildcard</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types1</span><span class="p">,</span> <span class="n">types2</span><span class="p">,</span> <span class="n">types3</span><span class="p">,</span> <span class="n">types4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span> <span class="c1"># Prefer specific definitions over ones with wildcards</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">tordef</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">_matchImproper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torsion</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">tordef</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;RBTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CMAPTorsion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CMAPTorsion records the information for a CMAP torsion definition.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types5</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CMAPTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CMAPTorsionGenerator constructs a CMAPTorsionForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">CMAPTorsionGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">CMAPTorsionGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Map&#39;</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">size</span><span class="o">*</span><span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;CMAP must have the same number of elements along each dimension&#39;</span><span class="p">)</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Torsion&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CMAPTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">])))</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">CMAPTorsionForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CMAPTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addMap</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">map</span><span class="p">))),</span> <span class="nb">map</span><span class="p">)</span>

        <span class="c1"># Find all chains of length 5</span>

        <span class="n">uniqueTorsions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">uniqueTorsions</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]):</span>
                <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">uniqueTorsions</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">atom</span><span class="p">))</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">uniqueTorsions</span><span class="p">))</span>
        <span class="n">wildcard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
            <span class="n">type5</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">4</span><span class="p">]]]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tordef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsions</span><span class="p">:</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types1</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types2</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types3</span>
                <span class="n">types4</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types4</span>
                <span class="n">types5</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types5</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type5</span> <span class="ow">in</span> <span class="n">types5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types5</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type5</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">hasWildcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">wildcard</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types1</span><span class="p">,</span> <span class="n">types2</span><span class="p">,</span> <span class="n">types3</span><span class="p">,</span> <span class="n">types4</span><span class="p">,</span> <span class="n">types5</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span> <span class="c1"># Prefer specific definitions over ones with wildcards</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">tordef</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CMAPTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMAPTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">NonbondedGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A NonbondedGenerator constructs a NonbondedForce.&quot;&quot;&quot;</span>

    <span class="n">SCALETOL</span> <span class="o">=</span> <span class="mf">1e-5</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">coulomb14scale</span><span class="p">,</span> <span class="n">lj14scale</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coulomb14scale</span> <span class="o">=</span> <span class="n">coulomb14scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lj14scale</span> <span class="o">=</span> <span class="n">lj14scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">forcefield</span><span class="p">,</span> <span class="s1">&#39;NonbondedForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">registerAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">registerAtom</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">NonbondedGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">NonbondedGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;coulomb14scale&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;lj14scale&#39;</span><span class="p">]))</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;NonbondedForce&gt; tags were found, probably in different files.  Simply add more types to the existing one.</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">coulomb14scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;coulomb14scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span> <span class="ow">or</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">lj14scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;lj14scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found multiple NonbondedForce tags with different 1-4 scales&#39;</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">,</span>
                     <span class="n">Ewald</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">Ewald</span><span class="p">,</span>
                     <span class="n">PME</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span>
                     <span class="n">LJPME</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">LJPME</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for NonbondedForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;switchDistance&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;switchDistance&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;ewaldErrorTolerance&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;ewaldErrorTolerance&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;useDispersionCorrection&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseDispersionCorrection</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;useDispersionCorrection&#39;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Create the exceptions.</span>

        <span class="n">bondIndices</span> <span class="o">=</span> <span class="n">_findBondsForExclusions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
        <span class="n">nonbonded</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nonbonded</span><span class="o">.</span><span class="n">createExceptionsFromBonds</span><span class="p">(</span><span class="n">bondIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coulomb14scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj14scale</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;NonbondedForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">LennardJonesGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A NBFix generator to construct the L-J force with NBFIX implemented as a lookup table&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">lj14scale</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lj14scale</span> <span class="o">=</span> <span class="n">lj14scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">forcefield</span><span class="p">,</span> <span class="s1">&#39;LennardJonesForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">registerNBFIX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">_convertParameterToNumber</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">[(</span><span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">[(</span><span class="n">type2</span><span class="p">,</span> <span class="n">type1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">registerLennardJones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">registerAtom</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">LennardJonesGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">LennardJonesGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;lj14scale&#39;</span><span class="p">]))</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;LennardJonesForce&gt; tags were found, probably in different files</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">lj14scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;lj14scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found multiple LennardJonesForce tags with different 1-4 scales&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">LJ</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Atom&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">registerLennardJones</span><span class="p">(</span><span class="n">LJ</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">Nbfix</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;NBFixPair&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">registerNBFIX</span><span class="p">(</span><span class="n">Nbfix</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># First derive the lookup tables.  We need to include entries for every type</span>
        <span class="c1"># that a) appears in the system and b) has unique parameters.</span>

        <span class="n">nbfixTypeSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">)</span>
        <span class="n">allTypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">mergedTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mergedTypeParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">paramsToMergedType</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">typeToMergedType</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">allTypes</span><span class="p">:</span>
            <span class="n">typeParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">paramsForType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">typeParams</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">typeParams</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nbfixTypeSet</span><span class="p">:</span>
                <span class="c1"># NBFIX types cannot be merged.</span>
                <span class="n">typeToMergedType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedTypes</span><span class="p">)</span>
                <span class="n">mergedTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">mergedTypeParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">paramsToMergedType</span><span class="p">:</span>
                <span class="c1"># We can merge this with another type.</span>
                <span class="n">typeToMergedType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramsToMergedType</span><span class="p">[</span><span class="n">params</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is a new type.</span>
                <span class="n">typeToMergedType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedTypes</span><span class="p">)</span>
                <span class="n">paramsToMergedType</span><span class="p">[</span><span class="n">params</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedTypes</span><span class="p">)</span>
                <span class="n">mergedTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">mergedTypeParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># Now everything is assigned. Create the A- and B-coefficient arrays</span>

        <span class="n">numLjTypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedTypes</span><span class="p">)</span>
        <span class="n">acoef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">numLjTypes</span><span class="o">*</span><span class="n">numLjTypes</span><span class="p">)</span>
        <span class="n">bcoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLjTypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLjTypes</span><span class="p">):</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">mergedTypes</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">mergedTypes</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">:</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sigma6</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">6</span>
                    <span class="n">acoef</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">numLjTypes</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sigma6</span><span class="o">*</span><span class="n">sigma6</span>
                    <span class="n">bcoef</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">numLjTypes</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sigma6</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mergedTypeParams</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">mergedTypeParams</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">sigma6</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">6</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mergedTypeParams</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mergedTypeParams</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">acoef</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">numLjTypes</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sigma6</span><span class="o">*</span><span class="n">sigma6</span>
                    <span class="n">bcoef</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">numLjTypes</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sigma6</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s1">&#39;acoef(type1, type2)/r^12 - bcoef(type1, type2)/r^6;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;acoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">numLjTypes</span><span class="p">,</span> <span class="n">numLjTypes</span><span class="p">,</span> <span class="n">acoef</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;bcoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">numLjTypes</span><span class="p">,</span> <span class="n">numLjTypes</span><span class="p">,</span> <span class="n">bcoef</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CutoffPeriodic</span><span class="p">,</span> <span class="n">Ewald</span><span class="p">,</span> <span class="n">PME</span><span class="p">,</span> <span class="n">LJPME</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">NoCutoff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Unrecognized nonbonded method [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;switchDistance&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;switchDistance&#39;</span><span class="p">])</span>

        <span class="c1"># Add the particles</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">((</span><span class="n">typeToMergedType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]],))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Create the exceptions.</span>

        <span class="n">bondIndices</span> <span class="o">=</span> <span class="n">_findBondsForExclusions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
        <span class="n">forceCopy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="n">forceCopy</span><span class="o">.</span><span class="n">createExclusionsFromBonds</span><span class="p">(</span><span class="n">bondIndices</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">createExclusionsFromBonds</span><span class="p">(</span><span class="n">bondIndices</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumExclusions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">forceCopy</span><span class="o">.</span><span class="n">getNumExclusions</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj14scale</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We need to create a CustomBondForce and use it to implement the scaled 1-4 interactions.</span>

            <span class="n">bonded</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">*epsilon*((sigma/r)^12-(sigma/r)^6)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lj14scale</span><span class="p">))</span>
            <span class="n">bonded</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
            <span class="n">bonded</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s1">&#39;epsilon&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">bonded</span><span class="p">)</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">forceCopy</span><span class="o">.</span><span class="n">getExclusionParticles</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">forceCopy</span><span class="o">.</span><span class="n">getNumExclusions</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumExclusions</span><span class="p">()):</span>
                <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getExclusionParticles</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">a1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
                <span class="n">a2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span>
                    <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">:</span>
                        <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfixTypes</span><span class="p">[(</span><span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">values1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">values2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">extra1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">getExtraParameters</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">extra2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljTypes</span><span class="o">.</span><span class="n">getExtraParameters</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">sigma1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">extra1</span><span class="p">[</span><span class="s1">&#39;sigma14&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;sigma14&#39;</span> <span class="ow">in</span> <span class="n">extra1</span> <span class="k">else</span> <span class="n">values1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">sigma2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">extra2</span><span class="p">[</span><span class="s1">&#39;sigma14&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;sigma14&#39;</span> <span class="ow">in</span> <span class="n">extra2</span> <span class="k">else</span> <span class="n">values2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">epsilon1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">extra1</span><span class="p">[</span><span class="s1">&#39;epsilon14&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;epsilon14&#39;</span> <span class="ow">in</span> <span class="n">extra1</span> <span class="k">else</span> <span class="n">values1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">epsilon2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">extra2</span><span class="p">[</span><span class="s1">&#39;epsilon14&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;epsilon14&#39;</span> <span class="ow">in</span> <span class="n">extra2</span> <span class="k">else</span> <span class="n">values2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sigma1</span><span class="o">+</span><span class="n">sigma2</span><span class="p">)</span>
                        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon1</span><span class="o">*</span><span class="n">epsilon2</span><span class="p">)</span>
                    <span class="n">bonded</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">))</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;LennardJonesForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LennardJonesGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">GBSAOBCGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A GBSAOBCGenerator constructs a GBSAOBCForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">forcefield</span><span class="p">,</span> <span class="s1">&#39;GBSAOBCForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">registerAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">registerAtom</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">GBSAOBCGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">GBSAOBCGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;GBSAOBCForce&gt; tags were found, probably in different files.  Simply add more types to the existing one.</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for GBSAOBCForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">GBSAOBCForce</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;soluteDielectric&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSoluteDielectric</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;soluteDielectric&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s1">&#39;solventDielectric&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSolventDielectric</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;solventDielectric&#39;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Disable the reaction field approximation, since it produces bad results when combined with GB.</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setReactionFieldDielectric</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;GBSAOBCForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GBSAOBCGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomBondGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomBondGenerator constructs a CustomBondForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perBondParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramValues</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomBondGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerBondParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perBondParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Bond&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">paramValues</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perBondParams</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perBondParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomBondGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomAngleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomAngleGenerator constructs a CustomAngleForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perAngleParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramValues</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomAngleGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerAngleParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perAngleParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Angle&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">paramValues</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perAngleParams</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomAngleForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perAngleParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerAngleParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomAngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomAngleGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomTorsion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomTorsion records the information for a custom torsion definition.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">paramValues</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s1">&#39;charmm&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramValues</span> <span class="o">=</span> <span class="n">paramValues</span>
        <span class="k">if</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;charmm&#39;</span><span class="p">,</span> <span class="s1">&#39;amber&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">ordering</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal ordering type </span><span class="si">%s</span><span class="s1"> for CustomTorsion (</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomTorsionGenerator constructs a CustomTorsionForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perTorsionParams</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomTorsionGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerTorsionParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perTorsionParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Proper&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">proper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CustomTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perTorsionParams</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Improper&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;ordering&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">improper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CustomTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perTorsionParams</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ordering&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">improper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CustomTorsion</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perTorsionParams</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomTorsionForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perTorsionParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">wildcard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propers</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tordef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proper</span><span class="p">:</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types1</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types2</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types3</span>
                <span class="n">types4</span> <span class="o">=</span> <span class="n">tordef</span><span class="o">.</span><span class="n">types4</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">):</span>
                    <span class="n">hasWildcard</span> <span class="o">=</span> <span class="p">(</span><span class="n">wildcard</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types1</span><span class="p">,</span> <span class="n">types2</span><span class="p">,</span> <span class="n">types3</span><span class="p">,</span> <span class="n">types4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span> <span class="c1"># Prefer specific definitions over ones with wildcards</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">tordef</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hasWildcard</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">paramValues</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">_matchImproper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torsion</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">tordef</span><span class="o">.</span><span class="n">paramValues</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomNonbondedGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomNonbondedGenerator constructs a CustomNonbondedForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">bondCutoff</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondCutoff</span> <span class="o">=</span> <span class="n">bondCutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomNonbondedGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bondCutoff&#39;</span><span class="p">]))</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerParticleParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;CustomNonbondedForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">functions</span> <span class="o">+=</span> <span class="n">_parseFunctions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for CustomNonbondedForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">_createFunctions</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Create the exclusions.</span>

        <span class="n">bondIndices</span> <span class="o">=</span> <span class="n">_findBondsForExclusions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
        <span class="n">nonbonded</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nonbonded</span><span class="o">.</span><span class="n">createExclusionsFromBonds</span><span class="p">(</span><span class="n">bondIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondCutoff</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomNonbondedForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomNonbondedGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomGBGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomGBGenerator constructs a CustomGBForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computedValues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energyTerms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomGBGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerParticleParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;CustomGBForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">computationMap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SingleParticle&quot;</span> <span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">SingleParticle</span><span class="p">,</span>
                          <span class="s2">&quot;ParticlePair&quot;</span> <span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">ParticlePair</span><span class="p">,</span>
                          <span class="s2">&quot;ParticlePairNoExclusions&quot;</span> <span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">ParticlePairNoExclusions</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ComputedValue&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">computedValues</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">computationMap</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]))</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;EnergyTerm&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">energyTerms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">term</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">computationMap</span><span class="p">[</span><span class="n">term</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]))</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">functions</span> <span class="o">+=</span> <span class="n">_parseFunctions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for CustomGBForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computedValues</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addComputedValue</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energyTerms</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addEnergyTerm</span><span class="p">(</span><span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">term</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_createFunctions</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomGBForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomGBGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomHbondGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomHbondGenerator constructs a CustomHbondForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perDonorParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perAcceptorParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donorParamValues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptorParamValues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomHbondGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">bondCutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bondCutoff&#39;</span><span class="p">])</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerDonor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;particlesPerDonor&#39;</span><span class="p">])</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerAcceptor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;particlesPerAcceptor&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerDonor</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerDonor</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal value for particlesPerDonor for CustomHbondForce&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerAcceptor</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">generator</span><span class="o">.</span><span class="n">particlesPerAcceptor</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal value for particlesPerAcceptor for CustomHbondForce&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerDonorParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perDonorParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerAcceptorParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perAcceptorParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">donor</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Donor&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">donor</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:</span><span class="n">generator</span><span class="o">.</span><span class="n">particlesPerDonor</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">donorTypes1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">donorTypes2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">donorTypes3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">donorParamValues</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">donor</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perDonorParams</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">acceptor</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Acceptor&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">acceptor</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:</span><span class="n">generator</span><span class="o">.</span><span class="n">particlesPerAcceptor</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">acceptorTypes2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">acceptorTypes3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">acceptorParamValues</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">acceptor</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">perAcceptorParams</span><span class="p">])</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">functions</span> <span class="o">+=</span> <span class="n">_parseFunctions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomHbondForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomHbondForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomHbondForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for CustomNonbondedForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomHbondForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perDonorParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerDonorParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perAcceptorParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerAcceptorParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">_createFunctions</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>

        <span class="c1"># Add donors.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particlesPerDonor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">type1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addDonor</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">particlesPerDonor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]]</span>
                <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addDonor</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addDonor</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorTypes3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addDonor</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">donorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Add acceptors.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particlesPerAcceptor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">type1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAcceptor</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">particlesPerAcceptor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]]</span>
                <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAcceptor</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAcceptor</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">)):</span>
                    <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorTypes3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAcceptor</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptorParamValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Add exclusions.</span>

        <span class="k">for</span> <span class="n">donor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">getNumDonors</span><span class="p">()):</span>
            <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">getDonorParameters</span><span class="p">(</span><span class="n">donor</span><span class="p">)</span>
            <span class="n">outerAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">))</span>
            <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">outerAtoms</span><span class="p">:</span>
                <span class="n">outerAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">excludedAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outerAtoms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bondCutoff</span><span class="p">):</span>
                <span class="n">newOuterAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">outerAtoms</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atom</span><span class="p">]:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span>
                        <span class="n">bondedAtom</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">atom2</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">atom</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">atom1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bondedAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludedAtoms</span><span class="p">:</span>
                            <span class="n">newOuterAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bondedAtom</span><span class="p">)</span>
                            <span class="n">excludedAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bondedAtom</span><span class="p">)</span>
                <span class="n">outerAtoms</span> <span class="o">=</span> <span class="n">newOuterAtoms</span>
            <span class="k">for</span> <span class="n">acceptor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">getNumAcceptors</span><span class="p">()):</span>
                <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">getAcceptorParameters</span><span class="p">(</span><span class="n">acceptor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">excludedAtoms</span> <span class="ow">or</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">excludedAtoms</span> <span class="ow">or</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">excludedAtoms</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">donor</span><span class="p">,</span> <span class="n">acceptor</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomHbondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomHbondGenerator</span><span class="o">.</span><span class="n">parseElement</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">CustomManyParticleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CustomManyParticleGenerator constructs a CustomManyParticleForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">particlesPerSet</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">permutationMode</span><span class="p">,</span> <span class="n">bondCutoff</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particlesPerSet</span> <span class="o">=</span> <span class="n">particlesPerSet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permutationMode</span> <span class="o">=</span> <span class="n">permutationMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondCutoff</span> <span class="o">=</span> <span class="n">bondCutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeFilters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">permutationMap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SinglePermutation&quot;</span> <span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="o">.</span><span class="n">SinglePermutation</span><span class="p">,</span>
                          <span class="s2">&quot;UniqueCentralParticle&quot;</span> <span class="p">:</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="o">.</span><span class="n">UniqueCentralParticle</span><span class="p">}</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">CustomManyParticleGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;particlesPerSet&#39;</span><span class="p">]),</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="n">permutationMap</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;permutationMode&#39;</span><span class="p">]],</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bondCutoff&#39;</span><span class="p">]))</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;GlobalParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PerParticleParameter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;TypeFilter&#39;</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">typeFilters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]),</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]))</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;CustomManyParticleForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">CutoffNonPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span>
                     <span class="n">CutoffPeriodic</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Illegal nonbonded method for CustomManyParticleForce&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particlesPerSet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setPermutationMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">permutationMode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalParams</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perParticleParams</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">types</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeFilters</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setTypeFilter</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous1D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous1DFunction</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous2D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Continuous3D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Continuous2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zsize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete1D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete1DFunction</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete2D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Discrete3D&#39;</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysize&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;zsize&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getExtraParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="s1">&#39;filterType&#39;</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Create exclusions based on bonds.</span>

        <span class="n">bondIndices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>

        <span class="c1"># If a virtual site does *not* share exclusions with another atom, add a bond between it and its first parent atom.</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">isVirtualSite</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">excludeWith</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">virtualSites</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">excludeWith</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">getParticle</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c1"># Certain particles, such as lone pairs and Drude particles, share exclusions with a parent atom.</span>
        <span class="c1"># If the parent atom does not interact with an atom, the child particle does not either.</span>

        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">bondIndices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child1</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom1</span><span class="p">]:</span>
                <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">child2</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                    <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">child2</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                <span class="n">bondIndices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">child2</span><span class="p">))</span>

        <span class="c1"># Create the exclusions.</span>

        <span class="n">nonbonded</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomManyParticleForce</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nonbonded</span><span class="o">.</span><span class="n">createExclusionsFromBonds</span><span class="p">(</span><span class="n">bondIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondCutoff</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;CustomManyParticleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomManyParticleGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="k">def</span> <span class="nf">getAtomPrint</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atomIndex</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">atomIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
        <span class="n">returnString</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%5d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">returnString</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

    <span class="k">return</span> <span class="n">returnString</span>

<span class="c1">#=============================================================================================</span>

<span class="k">def</span> <span class="nf">countConstraint</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

    <span class="n">bondCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">angleCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span><span class="p">:</span>
            <span class="n">bondCount</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">angleCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">isConstrained</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isConstrained</span><span class="p">):</span>
            <span class="n">angleCount</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constraints bond=</span><span class="si">%d</span><span class="s2"> angle=</span><span class="si">%d</span><span class="s2">  total=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bondCount</span><span class="p">,</span> <span class="n">angleCount</span><span class="p">,</span> <span class="p">(</span><span class="n">bondCount</span><span class="o">+</span><span class="n">angleCount</span><span class="p">)))</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaBondGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>

    <span class="sd">&quot;&quot;&quot;An AmoebaBondGenerator constructs a AmoebaBondForce.&quot;&quot;&quot;</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cubic</span><span class="p">,</span> <span class="n">quartic</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cubic</span> <span class="o">=</span> <span class="n">cubic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quartic</span> <span class="o">=</span> <span class="n">quartic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1"># &lt;AmoebaBondForce bond-cubic=&quot;-25.5&quot; bond-quartic=&quot;379.3125&quot;&gt;</span>
        <span class="c1"># &lt;Bond class1=&quot;1&quot; class2=&quot;2&quot; length=&quot;0.1437&quot; k=&quot;156900.0&quot;/&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaBondGenerator</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bond-cubic&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;bond-quartic&#39;</span><span class="p">]))</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Bond&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]))</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaBondGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1">#countConstraint(data)</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaBondForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaBondForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalBondCubic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cubic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalBondQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quartic</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">bond</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="o">.</span><span class="n">isConstrained</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaBondGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>
<span class="c1"># Add angle constraint</span>
<span class="c1">#=============================================================================================</span>

<span class="k">def</span> <span class="nf">addAngleConstraint</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">idealAngle</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">):</span>

    <span class="c1"># Find the two bonds that make this angle.</span>

    <span class="n">bond1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bond2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
        <span class="k">if</span> <span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">bond1</span> <span class="o">=</span> <span class="n">bond</span>
        <span class="k">elif</span> <span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">bond2</span> <span class="o">=</span> <span class="n">bond</span>

        <span class="c1"># Compute the distance between atoms and add a constraint</span>

        <span class="k">if</span> <span class="n">bond1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bond2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond1</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond2</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">l1</span><span class="o">*</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">l2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="o">*</span><span class="n">l2</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">idealAngle</span><span class="p">))</span>
                <span class="n">data</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">return</span>

<span class="c1">#=============================================================================================</span>
<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaAngleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>
    <span class="sd">&quot;&quot;&quot;An AmoebaAngleGenerator constructs a AmoebaAngleForce.&quot;&quot;&quot;</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceField</span><span class="p">,</span> <span class="n">cubic</span><span class="p">,</span> <span class="n">quartic</span><span class="p">,</span> <span class="n">pentic</span><span class="p">,</span> <span class="n">sextic</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span> <span class="o">=</span> <span class="n">forceField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubic</span> <span class="o">=</span> <span class="n">cubic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quartic</span> <span class="o">=</span> <span class="n">quartic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pentic</span> <span class="o">=</span> <span class="n">pentic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sextic</span> <span class="o">=</span> <span class="n">sextic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1"># &lt;AmoebaAngleForce angle-cubic=&quot;-0.014&quot; angle-quartic=&quot;5.6e-05&quot; angle-pentic=&quot;-7e-07&quot; angle-sextic=&quot;2.2e-08&quot;&gt;</span>
        <span class="c1">#   &lt;Angle class1=&quot;2&quot; class2=&quot;1&quot; class3=&quot;3&quot; k=&quot;0.0637259642196&quot; angle1=&quot;122.00&quot;  /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaAngleGenerator</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle-cubic&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle-quartic&#39;</span><span class="p">]),</span>  <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle-pentic&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle-sextic&#39;</span><span class="p">]))</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Angle&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">angleList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle1&#39;</span><span class="p">]))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle2&#39;</span><span class="p">]))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle3&#39;</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">angle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleList</span><span class="p">)</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaAngleGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># createForce is bypassed here since the AmoebaOutOfPlaneBendForce generator must first execute</span>
    <span class="c1"># and partition angles into in-plane and non-in-plane angles</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># createForcePostOpBendAngle is called by AmoebaOutOfPlaneBendForce with the list of</span>
    <span class="c1"># non-in-plane angles</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForcePostOpBendAngle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">angleList</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1"># get force</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaAngleForce</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaAngleForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set scalars</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleCubic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cubic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quartic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAnglePentic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pentic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleSextic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sextic</span><span class="p">)</span>

        <span class="n">DEG_TO_RAD</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

        <span class="k">for</span> <span class="n">angleDict</span> <span class="ow">in</span> <span class="n">angleList</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span>
            <span class="n">isConstrained</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span>

            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">isConstrained</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;idealAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">addAngleConstraint</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isConstrained</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                        <span class="n">lenAngle</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">lenAngle</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># get k-index by counting number of non-angle hydrogens on the central atom</span>
                            <span class="c1"># based on kangle.f</span>
                            <span class="n">numberOfHydrogens</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atom2</span> <span class="o">!=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atom2</span> <span class="o">!=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">dalton</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.90</span><span class="p">):</span>
                                    <span class="n">numberOfHydrogens</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atom1</span> <span class="o">!=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atom1</span> <span class="o">!=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">dalton</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.90</span><span class="p">):</span>
                                    <span class="n">numberOfHydrogens</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">numberOfHydrogens</span> <span class="o">&lt;</span> <span class="n">lenAngle</span><span class="p">):</span>
                                <span class="n">angleValue</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">numberOfHydrogens</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaAngleGenerator angle index=</span><span class="si">%d</span><span class="s2"> is out of range: [0, </span><span class="si">%5d</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberOfHydrogens</span><span class="p">,</span> <span class="n">lenAngle</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">angleValue</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;idealAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angleValue</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angleValue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># createForcePostOpBendInPlaneAngle is called by AmoebaOutOfPlaneBendForce with the list of</span>
    <span class="c1"># in-plane angles</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForcePostOpBendInPlaneAngle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">angleList</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1"># get force</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaInPlaneAngleForce</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaInPlaneAngleForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># scalars</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleCubic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cubic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quartic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAnglePentic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pentic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleSextic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sextic</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">angleDict</span> <span class="ow">in</span> <span class="n">angleList</span><span class="p">:</span>

            <span class="n">angle</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span>
            <span class="n">isConstrained</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span>

            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>

                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;idealAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isConstrained</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                        <span class="n">addAngleConstraint</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isConstrained</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaAngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaAngleGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>
<span class="c1"># Generator for the AmoebaOutOfPlaneBend covalent force; also calls methods in the</span>
<span class="c1"># AmoebaAngleGenerator to generate the AmoebaAngleForce and</span>
<span class="c1"># AmoebaInPlaneAngleForce</span>
<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaOutOfPlaneBendGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>

    <span class="sd">&quot;&quot;&quot;An AmoebaOutOfPlaneBendGenerator constructs a AmoebaOutOfPlaneBendForce.&quot;&quot;&quot;</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceField</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">cubic</span><span class="p">,</span> <span class="n">quartic</span><span class="p">,</span> <span class="n">pentic</span><span class="p">,</span> <span class="n">sextic</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span> <span class="o">=</span> <span class="n">forceField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubic</span> <span class="o">=</span> <span class="n">cubic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quartic</span> <span class="o">=</span> <span class="n">quartic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pentic</span> <span class="o">=</span> <span class="n">pentic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sextic</span> <span class="o">=</span> <span class="n">sextic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># Local version of findAtomTypes needed since class indices are 0 (i.e., not recognized)</span>
    <span class="c1"># for types3 and 4</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">findAtomTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceField</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the attributes on an XML tag to find the set of atom types for each atom it involves.&quot;&quot;&quot;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attrib</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">classAttrib</span> <span class="o">=</span> <span class="s1">&#39;class&#39;</span><span class="o">+</span><span class="n">suffix</span>
            <span class="k">if</span> <span class="n">classAttrib</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrib</span><span class="p">[</span><span class="n">classAttrib</span><span class="p">]</span> <span class="ow">in</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forceField</span><span class="o">.</span><span class="n">_atomClasses</span><span class="p">[</span><span class="n">attrib</span><span class="p">[</span><span class="n">classAttrib</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">types</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaOutOfPlaneBendForce type=&quot;ALLINGER&quot; opbend-cubic=&quot;-0.014&quot; opbend-quartic=&quot;5.6e-05&quot; opbend-pentic=&quot;-7e-07&quot; opbend-sextic=&quot;2.2e-08&quot;&gt;</span>
        <span class="c1">#   &lt;Angle class1=&quot;2&quot; class2=&quot;1&quot; class3=&quot;0&quot; class4=&quot;0&quot; k=&quot;0.0531474541591&quot;/&gt;</span>
        <span class="c1">#   &lt;Angle class1=&quot;3&quot; class2=&quot;1&quot; class3=&quot;0&quot; class4=&quot;0&quot; k=&quot;0.0898536095496&quot;/&gt;</span>

        <span class="c1"># get global scalar parameters</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaOutOfPlaneBendGenerator</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                                                   <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;opbend-cubic&#39;</span><span class="p">]),</span>
                                                   <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;opbend-quartic&#39;</span><span class="p">]),</span>
                                                   <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;opbend-pentic&#39;</span><span class="p">]),</span>
                                                   <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;opbend-sextic&#39;</span><span class="p">]))</span>

        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Angle&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">findAtomTypes</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">ks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaOutOfPlaneBendGenerator error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                               <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span> <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span> <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">],</span> <span class="n">angle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class4&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># Get middle atom in a angle</span>
    <span class="c1"># return index of middle atom or -1 if no middle is found</span>
    <span class="c1"># This method appears not to be needed since the angle[1] entry appears to always</span>
    <span class="c1"># be the middle atom. However, was unsure if this is guaranteed</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">getMiddleAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="c1"># find atom shared by both bonds making up the angle</span>

        <span class="n">middleAtom</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">atomIndex</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
            <span class="n">isMiddle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span> <span class="o">!=</span> <span class="n">atomIndex</span><span class="p">):</span>
                    <span class="n">partner</span> <span class="o">=</span> <span class="n">atom1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">partner</span> <span class="o">=</span> <span class="n">atom2</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">partner</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">partner</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">partner</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">isMiddle</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">isMiddle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">atomIndex</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1"># get force</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaOutOfPlaneBendForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaOutOfPlaneBendForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set scalars</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendCubic</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">cubic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quartic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendPentic</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pentic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendSextic</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sextic</span><span class="p">)</span>

        <span class="c1"># this hash is used to insure the out-of-plane-bend bonds</span>
        <span class="c1"># are only added once</span>

        <span class="n">skipAtoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># these lists are used in the partitioning of the angles into</span>
        <span class="c1"># angle and inPlane angles</span>

        <span class="n">inPlaneAngles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nonInPlaneAngles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nonInPlaneAnglesConstrained</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idealAngles</span> <span class="o">=</span> <span class="p">[]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">isConstrained</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="p">):</span>

            <span class="n">middleAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMiddleAtom</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">middleAtom</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">middleType</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]]</span>
                <span class="n">middleCovalency</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">middleType</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">middleCovalency</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># if middle atom has covalency of 3 and</span>
            <span class="c1"># the types of the middle atom and the partner atom (atom bonded to</span>
            <span class="c1"># middle atom, but not in angle) match types1 and types2, then</span>
            <span class="c1"># three out-of-plane bend angles are generated. Three in-plane angle</span>
            <span class="c1"># are also generated. If the conditions are not satisfied, the angle is marked as &#39;generic&#39; angle (not a in-plane angle)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">middleAtom</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">middleCovalency</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">middleAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipAtoms</span><span class="p">):</span>

                <span class="n">partners</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">partnerSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">partnerTypes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">partnerK</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]:</span>
                    <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                    <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span> <span class="o">!=</span> <span class="n">middleAtom</span><span class="p">):</span>
                        <span class="n">partner</span> <span class="o">=</span> <span class="n">atom1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">partner</span> <span class="o">=</span> <span class="n">atom2</span>

                    <span class="n">partnerType</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">partner</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                        <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">middleType</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">partnerType</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>
                            <span class="n">partners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partner</span><span class="p">)</span>
                            <span class="n">partnerSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">partner</span><span class="p">)</span>
                            <span class="n">partnerTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partnerType</span><span class="p">)</span>
                            <span class="n">partnerK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>

                    <span class="n">force</span><span class="o">.</span><span class="n">addOutOfPlaneBend</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">middleAtom</span><span class="p">,</span> <span class="n">partners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">partners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">partnerK</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addOutOfPlaneBend</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">middleAtom</span><span class="p">,</span> <span class="n">partners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">partners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">partnerK</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addOutOfPlaneBend</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">middleAtom</span><span class="p">,</span> <span class="n">partners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">partners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">partnerK</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># skipAtoms is used to insure angles are only included once</span>

                    <span class="n">skipAtoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">skipAtoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">skipAtoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">skipAtoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">partners</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># in-plane angle</span>

                    <span class="n">angleDict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">angleList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angleList</span>

                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">angleSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="k">for</span> <span class="n">atomIndex</span> <span class="ow">in</span> <span class="n">partnerSet</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atomIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angleSet</span><span class="p">):</span>
                            <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">)</span>

                    <span class="n">inPlaneAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleDict</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">angleDict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isConstrained</span>
                    <span class="n">nonInPlaneAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleDict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">middleAtom</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">middleCovalency</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">middleAtom</span> <span class="ow">in</span> <span class="n">skipAtoms</span><span class="p">):</span>

                    <span class="n">partnerSet</span> <span class="o">=</span> <span class="n">skipAtoms</span><span class="p">[</span><span class="n">middleAtom</span><span class="p">]</span>

                    <span class="n">angleDict</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="n">angleList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angleList</span>

                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isConstrained</span>

                    <span class="n">angleSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">angleSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="k">for</span> <span class="n">atomIndex</span> <span class="ow">in</span> <span class="n">partnerSet</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atomIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angleSet</span><span class="p">):</span>
                            <span class="n">angleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">)</span>

                    <span class="n">inPlaneAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleDict</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">angleDict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
                    <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isConstrained</span>
                    <span class="n">nonInPlaneAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleDict</span><span class="p">)</span>

        <span class="c1"># get AmoebaAngleGenerator and add AmoebaAngle and AmoebaInPlaneAngle forces</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;AmoebaAngleGenerator&#39;</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">createForcePostOpBendAngle</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">nonInPlaneAngles</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">createForcePostOpBendInPlaneAngle</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">inPlaneAngles</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;AmoebaStretchBendGenerator&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">angleDict</span> <span class="ow">in</span> <span class="n">inPlaneAngles</span><span class="p">:</span>
                    <span class="n">nonInPlaneAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angleDict</span><span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">createForcePostAmoebaBondForce</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">nonInPlaneAngles</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaOutOfPlaneBendForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaOutOfPlaneBendGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>
    <span class="sd">&quot;&quot;&quot;An AmoebaTorsionGenerator constructs a AmoebaTorsionForce.&quot;&quot;&quot;</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">torsionUnit</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">torsionUnit</span> <span class="o">=</span> <span class="n">torsionUnit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaTorsionForce torsionUnit=&quot;0.5&quot;&gt;</span>
        <span class="c1">#   &lt;Torsion class1=&quot;3&quot; class2=&quot;1&quot; class3=&quot;2&quot; class4=&quot;3&quot;   amp1=&quot;0.0&quot; angle1=&quot;0.0&quot;   amp2=&quot;0.0&quot; angle2=&quot;3.14159265359&quot;   amp3=&quot;0.0&quot; angle3=&quot;0.0&quot; /&gt;</span>
        <span class="c1">#   &lt;Torsion class1=&quot;3&quot; class2=&quot;1&quot; class3=&quot;2&quot; class4=&quot;6&quot;   amp1=&quot;0.0&quot; angle1=&quot;0.0&quot;   amp2=&quot;0.0&quot; angle2=&quot;3.14159265359&quot;   amp3=&quot;-0.263592&quot; angle3=&quot;0.0&quot; /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaTorsionGenerator</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;torsionUnit&#39;</span><span class="p">]))</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

        <span class="c1"># collect particle classes and t1,t2,t3,</span>
        <span class="c1"># where ti=[amplitude_i,angle_i]</span>

        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Torsion&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">tInfo</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="n">ampName</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
                    <span class="n">tInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">ampName</span><span class="p">]))</span>

                    <span class="n">angName</span> <span class="o">=</span> <span class="s1">&#39;angle&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
                    <span class="n">tInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">angName</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">generator</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tInfo</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">generator</span><span class="o">.</span><span class="n">t2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tInfo</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="n">generator</span><span class="o">.</span><span class="n">t3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tInfo</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaTorsionGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span>
                                    <span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">],</span>
                                    <span class="n">torsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class4&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nontorsionedMethod</span><span class="p">,</span> <span class="n">nontorsionedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propers</span><span class="p">:</span>

            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>

                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># match types in forward or reverse direction</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type4</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types4</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaPiTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>

    <span class="sd">&quot;&quot;&quot;An AmoebaPiTorsionGenerator constructs a AmoebaPiTorsionForce.&quot;&quot;&quot;</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">piTorsionUnit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piTorsionUnit</span> <span class="o">=</span> <span class="n">piTorsionUnit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaPiTorsionForce piTorsionUnit=&quot;1.0&quot;&gt;</span>
        <span class="c1">#   &lt;PiTorsion class1=&quot;1&quot; class2=&quot;3&quot; k=&quot;28.6604&quot; /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaPiTorsionGenerator</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;piTorsionUnit&#39;</span><span class="p">]))</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">piTorsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;PiTorsion&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">piTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">piTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaPiTorsionGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">piTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">piTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonpiTorsionedMethod</span><span class="p">,</span> <span class="n">nonpiTorsionedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaPiTorsionForce</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaPiTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>

            <span class="c1"># search for bonds with both atoms in bond having covalency == 3</span>

            <span class="n">atom1</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atom1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atom2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>

                <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom1</span><span class="p">]]</span>
                <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom2</span><span class="p">]]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>

                   <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                   <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                   <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types1</span><span class="p">):</span>

                       <span class="c1"># piTorsionAtom1, piTorsionAtom2 are the atoms bonded to atom1, excluding atom2</span>
                       <span class="c1"># piTorsionAtom5, piTorsionAtom6 are the atoms bonded to atom2, excluding atom1</span>

                       <span class="n">piTorsionAtom1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                       <span class="n">piTorsionAtom2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                       <span class="n">piTorsionAtom3</span> <span class="o">=</span> <span class="n">atom1</span>

                       <span class="n">piTorsionAtom4</span> <span class="o">=</span> <span class="n">atom2</span>
                       <span class="n">piTorsionAtom5</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                       <span class="n">piTorsionAtom6</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                       <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atom1</span><span class="p">]:</span>
                           <span class="n">bondedAtom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                           <span class="n">bondedAtom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                           <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="n">atom1</span><span class="p">):</span>
                               <span class="n">b1</span> <span class="o">=</span> <span class="n">bondedAtom1</span>
                           <span class="k">else</span><span class="p">:</span>
                               <span class="n">b1</span> <span class="o">=</span> <span class="n">bondedAtom2</span>
                           <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">!=</span> <span class="n">atom2</span><span class="p">):</span>
                               <span class="k">if</span> <span class="p">(</span><span class="n">piTorsionAtom1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                   <span class="n">piTorsionAtom1</span> <span class="o">=</span> <span class="n">b1</span>
                               <span class="k">else</span><span class="p">:</span>
                                   <span class="n">piTorsionAtom2</span> <span class="o">=</span> <span class="n">b1</span>

                       <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                           <span class="n">bondedAtom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                           <span class="n">bondedAtom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                           <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="n">atom2</span><span class="p">):</span>
                               <span class="n">b1</span> <span class="o">=</span> <span class="n">bondedAtom1</span>
                           <span class="k">else</span><span class="p">:</span>
                               <span class="n">b1</span> <span class="o">=</span> <span class="n">bondedAtom2</span>

                           <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">!=</span> <span class="n">atom1</span><span class="p">):</span>
                               <span class="k">if</span> <span class="p">(</span><span class="n">piTorsionAtom5</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                   <span class="n">piTorsionAtom5</span> <span class="o">=</span> <span class="n">b1</span>
                               <span class="k">else</span><span class="p">:</span>
                                   <span class="n">piTorsionAtom6</span> <span class="o">=</span> <span class="n">b1</span>

                       <span class="n">force</span><span class="o">.</span><span class="n">addPiTorsion</span><span class="p">(</span><span class="n">piTorsionAtom1</span><span class="p">,</span> <span class="n">piTorsionAtom2</span><span class="p">,</span> <span class="n">piTorsionAtom3</span><span class="p">,</span> <span class="n">piTorsionAtom4</span><span class="p">,</span> <span class="n">piTorsionAtom5</span><span class="p">,</span> <span class="n">piTorsionAtom6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaPiTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaPiTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaTorsionTorsionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>
    <span class="sd">&quot;&quot;&quot;An AmoebaTorsionTorsionGenerator constructs a AmoebaTorsionTorsionForce.&quot;&quot;&quot;</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types4</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types5</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaTorsionTorsionGenerator</span><span class="p">()</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">maxGridIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># &lt;AmoebaTorsionTorsionForce &gt;</span>
        <span class="c1"># &lt;TorsionTorsion class1=&quot;3&quot; class2=&quot;1&quot; class3=&quot;2&quot; class4=&quot;3&quot; class5=&quot;1&quot; grid=&quot;0&quot; nx=&quot;25&quot; ny=&quot;25&quot; /&gt;</span>

        <span class="k">for</span> <span class="n">torsionTorsion</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;TorsionTorsion&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types5</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

                <span class="n">gridIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gridIndex</span> <span class="o">&gt;</span> <span class="n">maxGridIndex</span><span class="p">):</span>
                    <span class="n">maxGridIndex</span> <span class="o">=</span> <span class="n">gridIndex</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">gridIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gridIndex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaTorsionTorsionGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span>
                                    <span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">],</span>
                                    <span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class4&#39;</span><span class="p">],</span>
                                    <span class="n">torsionTorsion</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class5&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

        <span class="c1"># load grid</span>

        <span class="c1"># xml source</span>

        <span class="c1"># &lt;TorsionTorsionGrid grid=&quot;0&quot; nx=&quot;25&quot; ny=&quot;25&quot; &gt;</span>
        <span class="c1"># &lt;Grid angle1=&quot;-180.00&quot; angle2=&quot;-180.00&quot; f=&quot;0.0&quot; fx=&quot;2.31064374824e-05&quot; fy=&quot;0.0&quot; fxy=&quot;-0.0052801799672&quot; /&gt;</span>
        <span class="c1"># &lt;Grid angle1=&quot;-165.00&quot; angle2=&quot;-180.00&quot; f=&quot;-0.66600912&quot; fx=&quot;-0.06983370052&quot; fy=&quot;-0.075058725744&quot; fxy=&quot;-0.0044462732032&quot; /&gt;</span>

        <span class="c1"># output grid:</span>

        <span class="c1">#     grid[x][y][0] = x value</span>
        <span class="c1">#     grid[x][y][1] = y value</span>
        <span class="c1">#     grid[x][y][2] = function value</span>
        <span class="c1">#     grid[x][y][3] = dfdx value</span>
        <span class="c1">#     grid[x][y][4] = dfdy value</span>
        <span class="c1">#     grid[x][y][5] = dfd(xy) value</span>

        <span class="n">maxGridIndex</span>    <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">grids</span> <span class="o">=</span> <span class="n">maxGridIndex</span><span class="o">*</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">torsionTorsionGrid</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;TorsionTorsionGrid&#39;</span><span class="p">):</span>

            <span class="n">gridIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torsionTorsionGrid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span> <span class="s2">&quot;grid&quot;</span><span class="p">])</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torsionTorsionGrid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span> <span class="s2">&quot;nx&quot;</span><span class="p">])</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torsionTorsionGrid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span> <span class="s2">&quot;ny&quot;</span><span class="p">])</span>

            <span class="n">grid</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gridCol</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">gridColIndex</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">gridEntry</span> <span class="ow">in</span> <span class="n">torsionTorsionGrid</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Grid&#39;</span><span class="p">):</span>

                <span class="n">gridRow</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle1&#39;</span><span class="p">]))</span>
                <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;angle2&#39;</span><span class="p">]))</span>
                <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s1">&#39;fx&#39;</span> <span class="ow">in</span> <span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;fx&#39;</span><span class="p">]))</span>
                    <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;fy&#39;</span><span class="p">]))</span>
                    <span class="n">gridRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gridEntry</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;fxy&#39;</span><span class="p">]))</span>
                <span class="n">gridCol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gridRow</span><span class="p">)</span>

                <span class="n">gridColIndex</span>  <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gridColIndex</span> <span class="o">==</span> <span class="n">nx</span><span class="p">):</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gridCol</span><span class="p">)</span>
                    <span class="n">gridCol</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">gridColIndex</span> <span class="o">=</span> <span class="mi">0</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">gridIndex</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">grids</span><span class="p">)):</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">grids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">gridIndex</span><span class="p">):</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">grids</span><span class="p">[</span><span class="n">gridIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">getChiralAtomIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">atomB</span><span class="p">,</span> <span class="n">atomC</span><span class="p">,</span> <span class="n">atomD</span><span class="p">):</span>

        <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># if atomC has four bonds, find the</span>
        <span class="c1"># two bonds that do not include atomB and atomD</span>
        <span class="c1"># set chiralAtomIndex to one of these, if they are</span>
        <span class="c1"># not the same atom(type/mass)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atomC</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">atomE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">atomF</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">atomC</span><span class="p">]:</span>
                <span class="n">bondedAtom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                <span class="n">bondedAtom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span>  <span class="n">bondedAtom1</span> <span class="o">==</span> <span class="n">atomC</span> <span class="ow">and</span> <span class="n">bondedAtom2</span> <span class="o">!=</span> <span class="n">atomB</span> <span class="ow">and</span> <span class="n">bondedAtom2</span> <span class="o">!=</span> <span class="n">atomD</span><span class="p">):</span>
                    <span class="n">hit</span> <span class="o">=</span> <span class="n">bondedAtom2</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">bondedAtom2</span> <span class="o">==</span> <span class="n">atomC</span> <span class="ow">and</span> <span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="n">atomB</span> <span class="ow">and</span> <span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="n">atomD</span><span class="p">):</span>
                    <span class="n">hit</span> <span class="o">=</span> <span class="n">bondedAtom1</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">atomE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">atomE</span> <span class="o">=</span> <span class="n">hit</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">atomF</span> <span class="o">=</span> <span class="n">hit</span>

            <span class="c1"># raise error if atoms E or F not found</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">atomE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">atomF</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;getChiralAtomIndex: error getting bonded partners of atomC=</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomC</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atomC</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">atomC</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

            <span class="c1"># check for different type/mass between atoms E &amp; F</span>

            <span class="n">typeE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomE</span><span class="p">]])</span>
            <span class="n">typeF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomF</span><span class="p">]])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">typeE</span> <span class="o">&gt;</span> <span class="n">typeF</span><span class="p">):</span>
                <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="n">atomE</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">typeF</span> <span class="o">&gt;</span> <span class="n">typeE</span><span class="p">):</span>
                <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="n">atomF</span>

            <span class="n">massE</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atomE</span><span class="p">)</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">dalton</span>
            <span class="n">massF</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">atomE</span><span class="p">)</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">dalton</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">massE</span> <span class="o">&gt;</span> <span class="n">massF</span><span class="p">):</span>
                <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="n">massE</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">massF</span> <span class="o">&gt;</span> <span class="n">massE</span><span class="p">):</span>
                <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="n">massF</span>

        <span class="k">return</span> <span class="n">chiralAtomIndex</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonpiTorsionedMethod</span><span class="p">,</span> <span class="n">nonpiTorsionedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaTorsionTorsionForce</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaTorsionTorsionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>

            <span class="c1"># search for bitorsions; based on TINKER subroutine bitors()</span>

            <span class="n">ib</span> <span class="o">=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">bondIndex</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">ib</span><span class="p">]:</span>
                <span class="n">bondedAtom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                <span class="n">bondedAtom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="n">ib</span><span class="p">):</span>
                    <span class="n">ia</span> <span class="o">=</span> <span class="n">bondedAtom1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ia</span> <span class="o">=</span> <span class="n">bondedAtom2</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ia</span> <span class="o">!=</span> <span class="n">ic</span> <span class="ow">and</span> <span class="n">ia</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">bondIndex</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
                        <span class="n">bondedAtom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                        <span class="n">bondedAtom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtom1</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">):</span>
                            <span class="n">ie</span> <span class="o">=</span> <span class="n">bondedAtom1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ie</span> <span class="o">=</span> <span class="n">bondedAtom2</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">!=</span> <span class="n">ic</span> <span class="ow">and</span> <span class="n">ie</span> <span class="o">!=</span> <span class="n">ib</span> <span class="ow">and</span> <span class="n">ie</span> <span class="o">!=</span> <span class="n">ia</span><span class="p">):</span>

                            <span class="c1"># found candidate set of atoms</span>
                            <span class="c1"># check if types match in order or reverse order</span>

                            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span>
                            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">ib</span><span class="p">]]</span>
                            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                            <span class="n">type4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">id</span><span class="p">]]</span>
                            <span class="n">type5</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">ie</span><span class="p">]]</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>

                                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">types4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">types5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types5</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                                <span class="c1"># match in order</span>

                                <span class="k">if</span> <span class="p">(</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type5</span> <span class="ow">in</span> <span class="n">types5</span><span class="p">):</span>
                                    <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChiralAtomIndex</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                                    <span class="n">force</span><span class="o">.</span><span class="n">addTorsionTorsion</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">chiralAtomIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                                <span class="c1"># match in reverse order</span>

                                <span class="k">elif</span> <span class="p">(</span><span class="n">type5</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type4</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types4</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types5</span><span class="p">):</span>
                                    <span class="n">chiralAtomIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChiralAtomIndex</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                                    <span class="n">force</span><span class="o">.</span><span class="n">addTorsionTorsion</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">chiralAtomIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridIndex</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># set grids</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grids</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setTorsionTorsionGrid</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaTorsionTorsionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaTorsionTorsionGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaStretchBendGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>
    <span class="sd">&quot;&quot;&quot;An AmoebaStretchBendGenerator constructs a AmoebaStretchBendForce.&quot;&quot;&quot;</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaStretchBendGenerator</span><span class="p">()</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

        <span class="c1"># &lt;AmoebaStretchBendForce stretchBendUnit=&quot;1.0&quot;&gt;</span>
        <span class="c1"># &lt;StretchBend class1=&quot;2&quot; class2=&quot;1&quot; class3=&quot;3&quot; k1=&quot;5.25776946506&quot; k2=&quot;5.25776946506&quot; /&gt;</span>
        <span class="c1"># &lt;StretchBend class1=&quot;2&quot; class2=&quot;1&quot; class3=&quot;4&quot; k1=&quot;3.14005676385&quot; k2=&quot;3.14005676385&quot; /&gt;</span>

        <span class="k">for</span> <span class="n">stretchBend</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;StretchBend&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">k1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]))</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">k2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaStretchBendGenerator : error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span>
                                    <span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span>
                                    <span class="n">stretchBend</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="c1"># The setup of this force is dependent on AmoebaBondForce and AmoebaAngleForce</span>
    <span class="c1"># having been called since the ideal bond lengths and angle are needed here.</span>
    <span class="c1"># As a conseqeunce, createForce() is not implemented since it is not guaranteed that the generator for</span>
    <span class="c1"># AmoebaBondForce and AmoebaAngleForce have been called prior to AmoebaStretchBendGenerator().</span>
    <span class="c1"># Instead, createForcePostAmoebaBondForce() is called</span>
    <span class="c1"># after the generators for AmoebaBondForce and AmoebaAngleForce have been called</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#=============================================================================================</span>

    <span class="c1"># Note: request for constrained bonds is ignored.</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForcePostAmoebaBondForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">angleList</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaStretchBendForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaStretchBendForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">angleDict</span> <span class="ow">in</span> <span class="n">angleList</span><span class="p">:</span>

            <span class="n">angle</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;isConstrained&#39;</span> <span class="ow">in</span> <span class="n">angleDict</span><span class="p">):</span>
                <span class="n">isConstrained</span> <span class="o">=</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;isConstrained&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isConstrained</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>

            <span class="n">radian</span> <span class="o">=</span> <span class="mf">57.2957795130</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>

                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># match types</span>
                <span class="c1"># get ideal bond lengths, bondAB, bondCB</span>
                <span class="c1"># get ideal angle</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="p">((</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">))):</span>
                    <span class="n">bondAB</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">bondCB</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">swap</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                        <span class="n">atom1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>
                        <span class="n">atom2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">bondAB</span> <span class="o">=</span> <span class="n">length</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">bondCB</span> <span class="o">=</span> <span class="n">length</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">bondCB</span> <span class="o">=</span> <span class="n">length</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atom2</span> <span class="o">==</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">bondAB</span> <span class="o">=</span> <span class="n">length</span>

                    <span class="c1"># check that ideal angle and bonds are set</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;idealAngle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angleDict</span><span class="p">):</span>

                       <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaStretchBendGenerator: ideal angle is not set for following entry:</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="s2">&quot;   types: </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> atoms: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">type3</span><span class="p">)</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
                       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="n">bondAB</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bondCB</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>

                       <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaStretchBendGenerator: bonds not set: </span><span class="si">%15.7e</span><span class="s2"> </span><span class="si">%15.7e</span><span class="s2">. for following entry:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bondAB</span><span class="p">,</span> <span class="n">bondCB</span><span class="p">)</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="s2">&quot;     types: [</span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">] atoms: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">type3</span><span class="p">)</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                       <span class="n">outputString</span> <span class="o">+=</span> <span class="n">getAtomPrint</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
                       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addStretchBend</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bondAB</span><span class="p">,</span> <span class="n">bondCB</span><span class="p">,</span> <span class="n">angleDict</span><span class="p">[</span><span class="s1">&#39;idealAngle&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">radian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaStretchBendForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaStretchBendGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaVdwGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A AmoebaVdwGenerator constructs a AmoebaVdwForce.&quot;&quot;&quot;</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">radiusrule</span><span class="p">,</span> <span class="n">radiustype</span><span class="p">,</span> <span class="n">radiussize</span><span class="p">,</span> <span class="n">epsilonrule</span><span class="p">,</span> <span class="n">vdw13Scale</span><span class="p">,</span> <span class="n">vdw14Scale</span><span class="p">,</span> <span class="n">vdw15Scale</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">radiusrule</span> <span class="o">=</span> <span class="n">radiusrule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radiustype</span> <span class="o">=</span> <span class="n">radiustype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radiussize</span> <span class="o">=</span> <span class="n">radiussize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epsilonrule</span> <span class="o">=</span> <span class="n">epsilonrule</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vdw13Scale</span> <span class="o">=</span> <span class="n">vdw13Scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdw14Scale</span> <span class="o">=</span> <span class="n">vdw14Scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdw15Scale</span> <span class="o">=</span> <span class="n">vdw15Scale</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1"># &lt;AmoebaVdwForce type=&quot;BUFFERED-14-7&quot; radiusrule=&quot;CUBIC-MEAN&quot; radiustype=&quot;R-MIN&quot; radiussize=&quot;DIAMETER&quot; epsilonrule=&quot;HHG&quot; vdw-13-scale=&quot;0.0&quot; vdw-14-scale=&quot;1.0&quot; vdw-15-scale=&quot;1.0&quot; &gt;</span>
        <span class="c1">#   &lt;Vdw class=&quot;1&quot; sigma=&quot;0.371&quot; epsilon=&quot;0.46024&quot; reduction=&quot;1.0&quot; /&gt;</span>
        <span class="c1">#   &lt;Vdw class=&quot;2&quot; sigma=&quot;0.382&quot; epsilon=&quot;0.422584&quot; reduction=&quot;1.0&quot; /&gt;</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">AmoebaVdwGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaVdwGenerator</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiusrule&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiustype&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiussize&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;epsilonrule&#39;</span><span class="p">],</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-13-scale&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-14-scale&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-15-scale&#39;</span><span class="p">]))</span>
            <span class="n">forceField</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="s1">&#39;AmoebaVdwForce&#39;</span><span class="p">,</span> <span class="s1">&#39;Vdw&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">,</span> <span class="s1">&#39;reduction&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;AmoebaVdwForce&gt; tags were found, probably in different files.  Simply add more types to the existing one.</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">vdw13Scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-13-scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span> <span class="ow">or</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">vdw14Scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-14-scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span> <span class="ow">or</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">vdw15Scale</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;vdw-15-scale&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">NonbondedGenerator</span><span class="o">.</span><span class="n">SCALETOL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found multiple AmoebaVdwForce tags with different scale factors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">generator</span><span class="o">.</span><span class="n">radiusrule</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiusrule&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">generator</span><span class="o">.</span><span class="n">epsilonrule</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;epsilonrule&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">generator</span><span class="o">.</span><span class="n">radiustype</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiustype&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">generator</span><span class="o">.</span><span class="n">radiussize</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;radiussize&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found multiple AmoebaVdwForce tags with different combining rules&#39;</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">two_six</span> <span class="o">=</span> <span class="mf">1.122462048309372</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getBondedParticleSets</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="n">bondedParticleSets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">))]</span>
        <span class="n">bondIndices</span> <span class="o">=</span> <span class="n">_findBondsForExclusions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">bondIndices</span><span class="p">:</span>
            <span class="n">bondedParticleSets</span><span class="p">[</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
            <span class="n">bondedParticleSets</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bondedParticleSets</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">sigmaMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ARITHMETIC&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GEOMETRIC&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CUBIC-MEAN&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">epsilonMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ARITHMETIC&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GEOMETRIC&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HARMONIC&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;HHG&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaVdwForce</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

        <span class="c1"># sigma and epsilon combining rules</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;sigmaCombiningRule&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">sigmaRule</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sigmaCombiningRule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sigmaRule</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sigmaMap</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSigmaCombiningRule</span><span class="p">(</span><span class="n">sigmaRule</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stringList</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">.</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sigmaMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;AmoebaVdwGenerator: sigma combining rule </span><span class="si">%s</span><span class="s2"> not recognized; valid values are </span><span class="si">%s</span><span class="s2">; using default.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaRule</span><span class="p">,</span> <span class="n">stringList</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSigmaCombiningRule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radiusrule</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;epsilonCombiningRule&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">epsilonRule</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;epsilonCombiningRule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">epsilonRule</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">epsilonMap</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setEpsilonCombiningRule</span><span class="p">(</span><span class="n">epsilonRule</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stringList</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">.</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">epsilonMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;AmoebaVdwGenerator: epsilon combining rule </span><span class="si">%s</span><span class="s2"> not recognized; valid values are </span><span class="si">%s</span><span class="s2">; using default.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epsilonRule</span><span class="p">,</span> <span class="n">stringList</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEpsilonCombiningRule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilonrule</span><span class="p">)</span>

        <span class="c1"># cutoff</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;vdwCutoff&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoff</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;vdwCutoff&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoff</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>

        <span class="c1"># dispersion correction</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;useDispersionCorrection&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseDispersionCorrection</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;useDispersionCorrection&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nonbondedMethod</span> <span class="o">==</span> <span class="n">PME</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaVdwForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>

        <span class="c1"># add particles to force</span>

        <span class="n">sigmaScale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiustype</span> <span class="o">==</span> <span class="s1">&#39;SIGMA&#39;</span><span class="p">:</span>
            <span class="n">sigmaScale</span> <span class="o">=</span> <span class="mf">1.122462048309372</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiussize</span> <span class="o">==</span> <span class="s1">&#39;DIAMETER&#39;</span><span class="p">:</span>
            <span class="n">sigmaScale</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="c1"># ivIndex = index of bonded partner for hydrogens; otherwise ivIndex = particle index</span>

            <span class="n">ivIndex</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">bondIndex</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomBonds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span> <span class="o">==</span> <span class="n">i</span><span class="p">):</span>
                    <span class="n">ivIndex</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ivIndex</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bondIndex</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span>

            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">ivIndex</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sigmaScale</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># set combining rules</span>

        <span class="c1"># set particle exclusions: self, 1-2 and 1-3 bonds</span>
        <span class="c1"># (1) collect in bondedParticleSets[i], 1-2 indices for all bonded partners of particle i</span>
        <span class="c1"># (2) add 1-2,1-3 and self to exclusion set</span>

        <span class="n">bondedParticleSets</span> <span class="o">=</span> <span class="n">AmoebaVdwGenerator</span><span class="o">.</span><span class="n">getBondedParticleSets</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="c1"># 1-2 partners</span>

            <span class="n">exclusionSet</span> <span class="o">=</span> <span class="n">bondedParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># 1-3 partners</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdw13Scale</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bondedParticle</span> <span class="ow">in</span> <span class="n">bondedParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">exclusionSet</span> <span class="o">=</span> <span class="n">exclusionSet</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bondedParticleSets</span><span class="p">[</span><span class="n">bondedParticle</span><span class="p">])</span>

            <span class="c1"># self</span>

            <span class="n">exclusionSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">force</span><span class="o">.</span><span class="n">setParticleExclusions</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exclusionSet</span><span class="p">))</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaVdwForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaVdwGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaMultipoleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>

    <span class="sd">&quot;&quot;&quot;A AmoebaMultipoleGenerator constructs a AmoebaMultipoleForce.&quot;&quot;&quot;</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span> <span class="o">=</span> <span class="n">forceField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#=============================================================================================</span>
    <span class="c1"># Set axis type</span>
    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setAxisType</span><span class="p">(</span><span class="n">kIndices</span><span class="p">):</span>

                <span class="c1"># set axis type</span>

                <span class="n">kIndicesLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kIndices</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kIndicesLen</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">ky</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ky</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">kIndicesLen</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">kx</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kx</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">kIndicesLen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">kz</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kz</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kIndices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">kIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">ZThenX</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">NoAxisType</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kz</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">ZOnly</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kz</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">kx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Bisector</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ky</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">ZBisect</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kz</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ky</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">axisType</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">ThreeFold</span>

                <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kz</span><span class="p">)</span>
                <span class="n">kIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kx</span><span class="p">)</span>
                <span class="n">kIndices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ky</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">axisType</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#   &lt;AmoebaMultipoleForce  direct11Scale=&quot;0.0&quot;  direct12Scale=&quot;1.0&quot;  direct13Scale=&quot;1.0&quot;  direct14Scale=&quot;1.0&quot;  mpole12Scale=&quot;0.0&quot;  mpole13Scale=&quot;0.0&quot;  mpole14Scale=&quot;0.4&quot;  mpole15Scale=&quot;0.8&quot;  mutual11Scale=&quot;1.0&quot;  mutual12Scale=&quot;1.0&quot;  mutual13Scale=&quot;1.0&quot;  mutual14Scale=&quot;1.0&quot;  polar12Scale=&quot;0.0&quot;  polar13Scale=&quot;0.0&quot;  polar14Intra=&quot;0.5&quot;  polar14Scale=&quot;1.0&quot;  polar15Scale=&quot;1.0&quot;  &gt;</span>
        <span class="c1"># &lt;Multipole class=&quot;1&quot;    kz=&quot;2&quot;    kx=&quot;4&quot;    c0=&quot;-0.22620&quot; d1=&quot;0.08214&quot; d2=&quot;0.00000&quot; d3=&quot;0.34883&quot; q11=&quot;0.11775&quot; q21=&quot;0.00000&quot; q22=&quot;-1.02185&quot; q31=&quot;-0.17555&quot; q32=&quot;0.00000&quot; q33=&quot;0.90410&quot;  /&gt;</span>
        <span class="c1"># &lt;Multipole class=&quot;2&quot;    kz=&quot;1&quot;    kx=&quot;3&quot;    c0=&quot;-0.15245&quot; d1=&quot;0.19517&quot; d2=&quot;0.00000&quot; d3=&quot;0.19687&quot; q11=&quot;-0.20677&quot; q21=&quot;0.00000&quot; q22=&quot;-0.48084&quot; q31=&quot;-0.01672&quot; q32=&quot;0.00000&quot; q33=&quot;0.68761&quot;  /&gt;</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">AmoebaMultipoleGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaMultipoleGenerator</span><span class="p">(</span><span class="n">forceField</span><span class="p">)</span>
            <span class="n">forceField</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;AmoebaMultipoleForce&gt; tags were found, probably in different files.  Simply add more types to the existing one.</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set type map: [ kIndices, multipoles, AMOEBA/OpenMM axis type]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Multipole&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="c1"># k-indices not provided default to 0</span>

                <span class="n">kIndices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])]</span>

                <span class="n">kStrings</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;kz&#39;</span><span class="p">,</span> <span class="s1">&#39;kx&#39;</span><span class="p">,</span> <span class="s1">&#39;ky&#39;</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">kString</span> <span class="ow">in</span> <span class="n">kStrings</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">kString</span><span class="p">]):</span>
                             <span class="n">kIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">kString</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># set axis type based on k-Indices</span>

                <span class="n">axisType</span> <span class="o">=</span> <span class="n">AmoebaMultipoleGenerator</span><span class="o">.</span><span class="n">setAxisType</span><span class="p">(</span><span class="n">kIndices</span><span class="p">)</span>

                <span class="c1"># set multipole</span>

                <span class="n">charge</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">])</span>

                <span class="n">conversion</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">dipole</span> <span class="o">=</span> <span class="p">[</span> <span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]),</span> <span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;d2&#39;</span><span class="p">]),</span> <span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;d3&#39;</span><span class="p">])]</span>

                <span class="n">quadrupole</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q11&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q21&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q31&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q21&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q22&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q32&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q31&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q32&#39;</span><span class="p">]))</span>
                <span class="n">quadrupole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;q33&#39;</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">):</span>
                        <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">valueMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;classIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;kIndices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIndices</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charge</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;dipole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dipole</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;quadrupole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quadrupole</span>
                    <span class="n">valueMap</span><span class="p">[</span><span class="s1">&#39;axisType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axisType</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valueMap</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaMultipoleGenerator: error getting type for multipole: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

        <span class="c1"># polarization parameters</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Polarize&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">classIndex</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">polarizability</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;polarizability&#39;</span><span class="p">])</span>
                <span class="n">thole</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;thole&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">thole</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">pdamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pdamp</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">polarizability</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span>

                <span class="n">pgrpMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                    <span class="n">pgrp</span> <span class="o">=</span> <span class="s1">&#39;pgrp&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pgrp</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                        <span class="n">pgrpMap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">pgrp</span><span class="p">])]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">):</span>
                        <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaMultipoleGenerator: polarize type not present: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">typeMapList</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                        <span class="n">hit</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">typeMap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typeMapList</span><span class="p">):</span>

                            <span class="k">if</span> <span class="p">(</span><span class="n">typeMap</span><span class="p">[</span><span class="s1">&#39;classIndex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">classIndex</span><span class="p">):</span>
                                <span class="n">typeMap</span><span class="p">[</span><span class="s1">&#39;polarizability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polarizability</span>
                                <span class="n">typeMap</span><span class="p">[</span><span class="s1">&#39;thole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thole</span>
                                <span class="n">typeMap</span><span class="p">[</span><span class="s1">&#39;pdamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdamp</span>
                                <span class="n">typeMap</span><span class="p">[</span><span class="s1">&#39;pgrpMap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgrpMap</span>
                                <span class="n">typeMapList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">typeMap</span>
                                <span class="n">hit</span> <span class="o">=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaMultipoleGenerator: error getting type for polarize: class index=</span><span class="si">%s</span><span class="s2"> not in multipole list?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaMultipoleGenerator: error getting type for polarize: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">setPolarGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bonded12ParticleSets</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="c1"># assign multipole parameters via only 1-2 connected atoms</span>

            <span class="n">multipoleDict</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">multipoleDict</span>
            <span class="n">pgrpMap</span> <span class="o">=</span> <span class="n">multipoleDict</span><span class="p">[</span><span class="s1">&#39;pgrpMap&#39;</span><span class="p">]</span>
            <span class="n">bondedAtomIndices</span> <span class="o">=</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroups</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">bondedAtomIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                <span class="n">bondedAtomType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomIndex</span><span class="p">]])</span>
                <span class="n">bondedAtom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomIndex</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomType</span> <span class="ow">in</span> <span class="n">pgrpMap</span><span class="p">):</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroups</span><span class="p">[</span><span class="n">bondedAtomIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">bondedAtom</span><span class="o">.</span><span class="n">polarizationGroups</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># pgrp11</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">group</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">notVisited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroups</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pgrpAtomIndex</span><span class="p">)</span>
                <span class="n">notVisited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pgrpAtomIndex</span><span class="p">)</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">)</span>
            <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">notVisited</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">nextAtom</span> <span class="o">=</span> <span class="n">notVisited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nextAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">):</span>
                   <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nextAtom</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">nextAtom</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroups</span><span class="p">:</span>
                       <span class="n">group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">):</span>
                           <span class="n">notVisited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

            <span class="n">pGroup</span> <span class="o">=</span> <span class="n">group</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pGroup</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">PolarizationCovalent11</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># pgrp12</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">pgrp11</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pgrp12</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp11</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bonded12</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]:</span>
                    <span class="n">pgrp12</span> <span class="o">=</span> <span class="n">pgrp12</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bonded12</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pgrp12</span> <span class="o">=</span> <span class="n">pgrp12</span> <span class="o">-</span> <span class="n">pgrp11</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp11</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pgrp12</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">PolarizationCovalent12</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># pgrp13</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">pgrp11</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pgrp12</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pgrp13</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp12</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bonded12</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]:</span>
                    <span class="n">pgrp13</span> <span class="o">=</span> <span class="n">pgrp13</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bonded12</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pgrp13</span> <span class="o">=</span> <span class="n">pgrp13</span> <span class="o">-</span> <span class="n">pgrp12</span>
            <span class="n">pgrp13</span> <span class="o">=</span> <span class="n">pgrp13</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pgrp11</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp11</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pgrp13</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">PolarizationCovalent13</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># pgrp14</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">pgrp11</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pgrp12</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pgrp13</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">pgrp14</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp13</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bonded12</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]:</span>
                    <span class="n">pgrp14</span> <span class="o">=</span> <span class="n">pgrp14</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bonded12</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">pgrp14</span> <span class="o">=</span> <span class="n">pgrp14</span> <span class="o">-</span> <span class="n">pgrp13</span>
            <span class="n">pgrp14</span> <span class="o">=</span> <span class="n">pgrp14</span> <span class="o">-</span> <span class="n">pgrp12</span>
            <span class="n">pgrp14</span> <span class="o">=</span> <span class="n">pgrp14</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pgrp11</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pgrpAtomIndex</span> <span class="ow">in</span> <span class="n">pgrp11</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pgrpAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pgrp14</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">PolarizationCovalent14</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroupSet</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">methodMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">NoCutoff</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span>
                     <span class="n">PME</span><span class="p">:</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">PME</span><span class="p">}</span>

        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nonbondedMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodMap</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;AmoebaMultipoleForce: input cutoff method not available.&quot;</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">methodMap</span><span class="p">[</span><span class="n">nonbondedMethod</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ewaldErrorTolerance&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;ewaldErrorTolerance&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;polarization&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">polarizationType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;polarization&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">polarizationType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setPolarizationType</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Direct</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">polarizationType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;extrapolated&#39;</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setPolarizationType</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Extrapolated</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setPolarizationType</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Mutual</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;aEwald&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAEwald</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;aEwald&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;pmeGridDimensions&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setPmeGridDimensions</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;pmeGridDimensions&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mutualInducedMaxIterations&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setMutualInducedMaxIterations</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;mutualInducedMaxIterations&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mutualInducedTargetEpsilon&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setMutualInducedTargetEpsilon</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;mutualInducedTargetEpsilon&#39;</span><span class="p">]))</span>

        <span class="c1"># add particles to force</span>
        <span class="c1"># throw error if particle type not available</span>

        <span class="c1"># get 1-2, 1-3, 1-4, 1-5 bonded sets</span>

        <span class="c1"># 1-2</span>

        <span class="n">bonded12ParticleSets</span> <span class="o">=</span> <span class="n">AmoebaVdwGenerator</span><span class="o">.</span><span class="n">getBondedParticleSets</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># 1-3</span>

        <span class="n">bonded13ParticleSets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">bonded13Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">bonded12ParticleSet</span> <span class="o">=</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bonded12ParticleSet</span><span class="p">:</span>
                <span class="n">bonded13Set</span> <span class="o">=</span> <span class="n">bonded13Set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># remove 1-2 and self from set</span>

            <span class="n">bonded13Set</span> <span class="o">=</span> <span class="n">bonded13Set</span> <span class="o">-</span> <span class="n">bonded12ParticleSet</span>
            <span class="n">selfSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">selfSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">bonded13Set</span> <span class="o">=</span> <span class="n">bonded13Set</span> <span class="o">-</span> <span class="n">selfSet</span>
            <span class="n">bonded13Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bonded13Set</span><span class="p">))</span>
            <span class="n">bonded13ParticleSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bonded13Set</span><span class="p">)</span>

        <span class="c1"># 1-4</span>

        <span class="n">bonded14ParticleSets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">bonded14Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">bonded13ParticleSet</span> <span class="o">=</span> <span class="n">bonded13ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bonded13ParticleSet</span><span class="p">:</span>
                <span class="n">bonded14Set</span> <span class="o">=</span> <span class="n">bonded14Set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># remove 1-3, 1-2 and self from set</span>

            <span class="n">bonded14Set</span> <span class="o">=</span> <span class="n">bonded14Set</span> <span class="o">-</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bonded14Set</span> <span class="o">=</span> <span class="n">bonded14Set</span> <span class="o">-</span> <span class="n">bonded13ParticleSet</span>
            <span class="n">selfSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">selfSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">bonded14Set</span> <span class="o">=</span> <span class="n">bonded14Set</span> <span class="o">-</span> <span class="n">selfSet</span>
            <span class="n">bonded14Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bonded14Set</span><span class="p">))</span>
            <span class="n">bonded14ParticleSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bonded14Set</span><span class="p">)</span>

        <span class="c1"># 1-5</span>

        <span class="n">bonded15ParticleSets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">bonded14ParticleSet</span> <span class="o">=</span> <span class="n">bonded14ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bonded14ParticleSet</span><span class="p">:</span>
                <span class="n">bonded15Set</span> <span class="o">=</span> <span class="n">bonded15Set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># remove 1-4, 1-3, 1-2 and self from set</span>

            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="n">bonded15Set</span> <span class="o">-</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="n">bonded15Set</span> <span class="o">-</span> <span class="n">bonded13ParticleSets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="n">bonded15Set</span> <span class="o">-</span> <span class="n">bonded14ParticleSet</span>
            <span class="n">selfSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">selfSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="n">bonded15Set</span> <span class="o">-</span> <span class="n">selfSet</span>
            <span class="n">bonded15Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bonded15Set</span><span class="p">))</span>
            <span class="n">bonded15ParticleSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bonded15Set</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">:</span>

                <span class="n">multipoleList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># assign multipole parameters via only 1-2 connected atoms</span>

                <span class="k">for</span> <span class="n">multipoleDict</span> <span class="ow">in</span> <span class="n">multipoleList</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="n">kIndices</span> <span class="o">=</span> <span class="n">multipoleDict</span><span class="p">[</span><span class="s1">&#39;kIndices&#39;</span><span class="p">]</span>

                    <span class="n">kz</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">kx</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ky</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

                    <span class="c1"># assign multipole parameters</span>
                    <span class="c1">#    (1) get bonded partners</span>
                    <span class="c1">#    (2) match parameter types</span>

                    <span class="n">bondedAtomIndices</span> <span class="o">=</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
                    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">yaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>

                       <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                           <span class="k">break</span>

                       <span class="n">bondedAtomZType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]])</span>
                       <span class="n">bondedAtomZ</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomZType</span> <span class="o">==</span> <span class="n">kz</span><span class="p">):</span>
                          <span class="k">for</span> <span class="n">bondedAtomXIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                              <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomXIndex</span> <span class="o">==</span> <span class="n">bondedAtomZIndex</span> <span class="ow">or</span> <span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                  <span class="k">continue</span>
                              <span class="n">bondedAtomXType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]])</span>
                              <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomXType</span> <span class="o">==</span> <span class="n">kx</span><span class="p">):</span>
                                  <span class="k">if</span> <span class="p">(</span><span class="n">ky</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                      <span class="n">zaxis</span> <span class="o">=</span> <span class="n">bondedAtomZIndex</span>
                                      <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>
                                      <span class="k">if</span><span class="p">(</span> <span class="n">bondedAtomXType</span> <span class="o">==</span> <span class="n">bondedAtomZType</span> <span class="ow">and</span> <span class="n">xaxis</span> <span class="o">&lt;</span> <span class="n">zaxis</span> <span class="p">):</span>
                                          <span class="n">swapI</span> <span class="o">=</span> <span class="n">zaxis</span>
                                          <span class="n">zaxis</span> <span class="o">=</span> <span class="n">xaxis</span>
                                          <span class="n">xaxis</span> <span class="o">=</span> <span class="n">swapI</span>
                                      <span class="k">else</span><span class="p">:</span>
                                          <span class="k">for</span> <span class="n">bondedAtomXIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                                              <span class="n">bondedAtomX1Type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]])</span>
                                              <span class="k">if</span><span class="p">(</span> <span class="n">bondedAtomX1Type</span> <span class="o">==</span> <span class="n">kx</span> <span class="ow">and</span> <span class="n">bondedAtomXIndex</span> <span class="o">!=</span> <span class="n">bondedAtomZIndex</span> <span class="ow">and</span> <span class="n">bondedAtomXIndex</span> <span class="o">&lt;</span> <span class="n">xaxis</span> <span class="p">):</span>
                                                  <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>

                                      <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                                      <span class="n">hit</span> <span class="o">=</span> <span class="mi">1</span>
                                  <span class="k">else</span><span class="p">:</span>
                                      <span class="k">for</span> <span class="n">bondedAtomYIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                                          <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomYIndex</span> <span class="o">==</span> <span class="n">bondedAtomZIndex</span> <span class="ow">or</span> <span class="n">bondedAtomYIndex</span> <span class="o">==</span> <span class="n">bondedAtomXIndex</span> <span class="ow">or</span> <span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                              <span class="k">continue</span>
                                          <span class="n">bondedAtomYType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomYIndex</span><span class="p">]])</span>
                                          <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomYType</span> <span class="o">==</span> <span class="n">ky</span><span class="p">):</span>
                                              <span class="n">zaxis</span> <span class="o">=</span> <span class="n">bondedAtomZIndex</span>
                                              <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>
                                              <span class="n">yaxis</span> <span class="o">=</span> <span class="n">bondedAtomYIndex</span>
                                              <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                                              <span class="n">hit</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="c1"># assign multipole parameters via 1-2 and 1-3 connected atoms</span>

                <span class="k">for</span> <span class="n">multipoleDict</span> <span class="ow">in</span> <span class="n">multipoleList</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="n">kIndices</span> <span class="o">=</span> <span class="n">multipoleDict</span><span class="p">[</span><span class="s1">&#39;kIndices&#39;</span><span class="p">]</span>

                    <span class="n">kz</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">kx</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ky</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

                    <span class="c1"># assign multipole parameters</span>
                    <span class="c1">#    (1) get bonded partners</span>
                    <span class="c1">#    (2) match parameter types</span>

                    <span class="n">bondedAtom12Indices</span> <span class="o">=</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
                    <span class="n">bondedAtom13Indices</span> <span class="o">=</span> <span class="n">bonded13ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>

                    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">yaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="k">for</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bondedAtom12Indices</span><span class="p">:</span>

                       <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                           <span class="k">break</span>

                       <span class="n">bondedAtomZType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]])</span>
                       <span class="n">bondedAtomZ</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]</span>

                       <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomZType</span> <span class="o">==</span> <span class="n">kz</span><span class="p">):</span>
                          <span class="k">for</span> <span class="n">bondedAtomXIndex</span> <span class="ow">in</span> <span class="n">bondedAtom13Indices</span><span class="p">:</span>

                              <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomXIndex</span> <span class="o">==</span> <span class="n">bondedAtomZIndex</span> <span class="ow">or</span> <span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                  <span class="k">continue</span>
                              <span class="n">bondedAtomXType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]])</span>
                              <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomXType</span> <span class="o">==</span> <span class="n">kx</span> <span class="ow">and</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]):</span>
                                  <span class="k">if</span> <span class="p">(</span><span class="n">ky</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                      <span class="n">zaxis</span> <span class="o">=</span> <span class="n">bondedAtomZIndex</span>
                                      <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>

                                      <span class="c1"># select xaxis w/ smallest index</span>

                                      <span class="k">for</span> <span class="n">bondedAtomXIndex</span> <span class="ow">in</span> <span class="n">bondedAtom13Indices</span><span class="p">:</span>
                                          <span class="n">bondedAtomX1Type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]])</span>
                                          <span class="k">if</span><span class="p">(</span> <span class="n">bondedAtomX1Type</span> <span class="o">==</span> <span class="n">kx</span> <span class="ow">and</span> <span class="n">bondedAtomXIndex</span> <span class="o">!=</span> <span class="n">bondedAtomZIndex</span> <span class="ow">and</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">bondedAtomXIndex</span><span class="p">]</span> <span class="ow">and</span> <span class="n">bondedAtomXIndex</span> <span class="o">&lt;</span> <span class="n">xaxis</span> <span class="p">):</span>
                                              <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>

                                      <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                                      <span class="n">hit</span> <span class="o">=</span> <span class="mi">3</span>
                                  <span class="k">else</span><span class="p">:</span>
                                      <span class="k">for</span> <span class="n">bondedAtomYIndex</span> <span class="ow">in</span> <span class="n">bondedAtom13Indices</span><span class="p">:</span>
                                          <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomYIndex</span> <span class="o">==</span> <span class="n">bondedAtomZIndex</span> <span class="ow">or</span> <span class="n">bondedAtomYIndex</span> <span class="o">==</span> <span class="n">bondedAtomXIndex</span> <span class="ow">or</span> <span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                              <span class="k">continue</span>
                                          <span class="n">bondedAtomYType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomYIndex</span><span class="p">]])</span>
                                          <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomYType</span> <span class="o">==</span> <span class="n">ky</span> <span class="ow">and</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">bondedAtomYIndex</span><span class="p">]):</span>
                                              <span class="n">zaxis</span> <span class="o">=</span> <span class="n">bondedAtomZIndex</span>
                                              <span class="n">xaxis</span> <span class="o">=</span> <span class="n">bondedAtomXIndex</span>
                                              <span class="n">yaxis</span> <span class="o">=</span> <span class="n">bondedAtomYIndex</span>
                                              <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                                              <span class="n">hit</span> <span class="o">=</span> <span class="mi">4</span>

                <span class="c1"># assign multipole parameters via only a z-defining atom</span>

                <span class="k">for</span> <span class="n">multipoleDict</span> <span class="ow">in</span> <span class="n">multipoleList</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="n">kIndices</span> <span class="o">=</span> <span class="n">multipoleDict</span><span class="p">[</span><span class="s1">&#39;kIndices&#39;</span><span class="p">]</span>

                    <span class="n">kz</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">kx</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">yaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="k">for</span> <span class="n">bondedAtomZIndex</span> <span class="ow">in</span> <span class="n">bondedAtom12Indices</span><span class="p">:</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">break</span>

                        <span class="n">bondedAtomZType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]])</span>
                        <span class="n">bondedAtomZ</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomZIndex</span><span class="p">]</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">kx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kz</span> <span class="o">==</span> <span class="n">bondedAtomZType</span><span class="p">):</span>
                            <span class="n">zaxis</span> <span class="o">=</span> <span class="n">bondedAtomZIndex</span>
                            <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                            <span class="n">hit</span> <span class="o">=</span> <span class="mi">5</span>

                <span class="c1"># assign multipole parameters via no connected atoms</span>

                <span class="k">for</span> <span class="n">multipoleDict</span> <span class="ow">in</span> <span class="n">multipoleList</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="n">kIndices</span> <span class="o">=</span> <span class="n">multipoleDict</span><span class="p">[</span><span class="s1">&#39;kIndices&#39;</span><span class="p">]</span>

                    <span class="n">kz</span> <span class="o">=</span> <span class="n">kIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">yaxis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">kz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">savedMultipoleDict</span> <span class="o">=</span> <span class="n">multipoleDict</span>
                        <span class="n">hit</span> <span class="o">=</span> <span class="mi">6</span>

                <span class="c1"># add particle if there was a hit</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">hit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>

                    <span class="n">atom</span><span class="o">.</span><span class="n">multipoleDict</span> <span class="o">=</span> <span class="n">savedMultipoleDict</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">polarizationGroups</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">newIndex</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">addMultipole</span><span class="p">(</span><span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">],</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;dipole&#39;</span><span class="p">],</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;quadrupole&#39;</span><span class="p">],</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;axisType&#39;</span><span class="p">],</span>
                                                                 <span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;thole&#39;</span><span class="p">],</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;pdamp&#39;</span><span class="p">],</span> <span class="n">savedMultipoleDict</span><span class="p">[</span><span class="s1">&#39;polarizability&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">atomIndex</span> <span class="o">==</span> <span class="n">newIndex</span><span class="p">):</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Covalent12</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]))</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Covalent13</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bonded13ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]))</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Covalent14</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bonded14ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]))</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">setCovalentMap</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="o">.</span><span class="n">Covalent15</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bonded15ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atom </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> is out of sync!.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atom </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> was not assigned.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No multipole type for atom </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

        <span class="c1"># set polar groups</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setPolarGroups</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bonded12ParticleSets</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaMultipoleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaMultipoleGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaWcaDispersionGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A AmoebaWcaDispersionGenerator constructs a AmoebaWcaDispersionForce.&quot;&quot;&quot;</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epso</span><span class="p">,</span> <span class="n">epsh</span><span class="p">,</span> <span class="n">rmino</span><span class="p">,</span> <span class="n">rminh</span><span class="p">,</span> <span class="n">awater</span><span class="p">,</span> <span class="n">slevy</span><span class="p">,</span> <span class="n">dispoff</span><span class="p">,</span> <span class="n">shctd</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epso</span> <span class="o">=</span> <span class="n">epso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsh</span> <span class="o">=</span> <span class="n">epsh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmino</span> <span class="o">=</span> <span class="n">rmino</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rminh</span> <span class="o">=</span> <span class="n">rminh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">awater</span> <span class="o">=</span> <span class="n">awater</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slevy</span> <span class="o">=</span> <span class="n">slevy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispoff</span> <span class="o">=</span> <span class="n">dispoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shctd</span> <span class="o">=</span> <span class="n">shctd</span>

    <span class="c1">#=========================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaWcaDispersionForce epso=&quot;0.46024&quot; epsh=&quot;0.056484&quot; rmino=&quot;0.17025&quot; rminh=&quot;0.13275&quot; awater=&quot;33.428&quot; slevy=&quot;1.0&quot;  dispoff=&quot;0.026&quot; shctd=&quot;0.81&quot; &gt;</span>
        <span class="c1">#   &lt;WcaDispersion class=&quot;1&quot; radius=&quot;0.1855&quot; epsilon=&quot;0.46024&quot; /&gt;</span>
        <span class="c1">#   &lt;WcaDispersion class=&quot;2&quot; radius=&quot;0.191&quot; epsilon=&quot;0.422584&quot; /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaWcaDispersionGenerator</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;epso&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;epsh&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;rmino&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;rminh&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;awater&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;slevy&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;dispoff&#39;</span><span class="p">],</span>
                                                  <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;shctd&#39;</span><span class="p">])</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_AtomTypeParameters</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="s1">&#39;AmoebaWcaDispersionForce&#39;</span><span class="p">,</span> <span class="s1">&#39;WcaDispersion&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">))</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parseDefinitions</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1"># get or create force depending on whether it has already been added to the system</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaWcaDispersionForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaWcaDispersionForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># add particles to force</span>
        <span class="c1"># throw error if particle type not available</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setEpso</span><span class="p">(</span>   <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epso</span>   <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setEpsh</span><span class="p">(</span>   <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsh</span>   <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setRmino</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmino</span>  <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setRminh</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rminh</span>  <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setDispoff</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispoff</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setSlevy</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slevy</span>  <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAwater</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">awater</span> <span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setShctd</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shctd</span>  <span class="p">))</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getAtomParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaWcaDispersionForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaWcaDispersionGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaGeneralizedKirkwoodGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A AmoebaGeneralizedKirkwoodGenerator constructs a AmoebaGeneralizedKirkwoodForce.&quot;&quot;&quot;</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceField</span><span class="p">,</span> <span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">includeCavityTerm</span><span class="p">,</span> <span class="n">probeRadius</span><span class="p">,</span> <span class="n">surfaceAreaFactor</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span> <span class="o">=</span> <span class="n">forceField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solventDielectric</span> <span class="o">=</span> <span class="n">solventDielectric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soluteDielectric</span> <span class="o">=</span> <span class="n">soluteDielectric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeCavityTerm</span> <span class="o">=</span> <span class="n">includeCavityTerm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probeRadius</span> <span class="o">=</span> <span class="n">probeRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surfaceAreaFactor</span> <span class="o">=</span> <span class="n">surfaceAreaFactor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">radiusTypeMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radiusTypeMap</span><span class="p">[</span><span class="s1">&#39;Bondi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bondiMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiusTypeMap</span><span class="p">[</span><span class="s1">&#39;Bondi&#39;</span><span class="p">]</span>
        <span class="n">rscale</span> <span class="o">=</span> <span class="mf">1.03</span>

        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.12</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.14</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.18</span><span class="o">*</span><span class="n">rscale</span>

        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.170</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.155</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.152</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.147</span><span class="o">*</span><span class="n">rscale</span>

        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.154</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.210</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.180</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.180</span><span class="o">*</span><span class="n">rscale</span>

        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.175</span> <span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.188</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.190</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.185</span><span class="o">*</span><span class="n">rscale</span>

        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.202</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.198</span><span class="o">*</span><span class="n">rscale</span>
        <span class="n">bondiMap</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.216</span><span class="o">*</span><span class="n">rscale</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">getObcShct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">atomIndex</span><span class="p">):</span>

        <span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
        <span class="n">atomicNumber</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">atomic_number</span>
        <span class="n">shct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="c1"># shct</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>                 <span class="c1"># H(1)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>               <span class="c1"># C(6)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.72</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">7</span><span class="p">):</span>               <span class="c1"># N(7)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.79</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>               <span class="c1"># O(8)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">9</span><span class="p">):</span>               <span class="c1"># F(9)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.88</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">15</span><span class="p">):</span>              <span class="c1"># P(15)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.86</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">16</span><span class="p">):</span>              <span class="c1"># S(16)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.96</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">26</span><span class="p">):</span>              <span class="c1"># Fe(26)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.88</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shct</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;getObcShct: no GK overlap scale factor for atom </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">shct</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">getAmoebaTypeRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bondedAtomIndices</span><span class="p">,</span> <span class="n">atomIndex</span><span class="p">):</span>

        <span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
        <span class="n">atomicNumber</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">atomic_number</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>                  <span class="c1"># H(1)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.132</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedAtomIndices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;AmoebaGeneralizedKirkwoodGenerator: error getting atom bonded to </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">bondedAtomIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                <span class="n">bondedAtomAtomicNumber</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">atomic_number</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomAtomicNumber</span> <span class="o">==</span> <span class="mi">7</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.11</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomAtomicNumber</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.105</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>               <span class="c1"># Li(3)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>               <span class="c1"># C(6)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.20</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedAtomIndices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.205</span>

            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedAtomIndices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bondedAtomIndex</span> <span class="ow">in</span> <span class="n">bondedAtomIndices</span><span class="p">:</span>
                   <span class="n">bondedAtomAtomicNumber</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bondedAtomIndex</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">atomic_number</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">bondedAtomAtomicNumber</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">bondedAtomAtomicNumber</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
                       <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.175</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">7</span><span class="p">):</span>               <span class="c1"># N(7)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.16</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>               <span class="c1"># O(8)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.155</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondedAtomIndices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.145</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">9</span><span class="p">):</span>               <span class="c1"># F(9)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.154</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.146</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">11</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.209</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">12</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.179</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">14</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.189</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">15</span><span class="p">):</span>              <span class="c1"># P(15)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.196</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">16</span><span class="p">):</span>              <span class="c1"># S(16)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.186</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">17</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.182</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">18</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.179</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">19</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.223</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">20</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.191</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">35</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">2.00</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">36</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.190</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">37</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.226</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">53</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.237</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">54</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.207</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">55</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.263</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="o">==</span> <span class="mi">56</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.230</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">radius</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;No GK radius for atom </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="n">outputString</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">radius</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">getBondiTypeRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bondedAtomIndices</span><span class="p">,</span> <span class="n">atomIndex</span><span class="p">):</span>

        <span class="n">bondiMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiusTypeMap</span><span class="p">[</span><span class="s1">&#39;Bondi&#39;</span><span class="p">]</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">]</span>
        <span class="n">atomicNumber</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">atomic_number</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atomicNumber</span> <span class="ow">in</span> <span class="n">bondiMap</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">bondiMap</span><span class="p">[</span><span class="n">atomicNumber</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;Warning no Bondi radius for atom </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> using default value=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="n">outputString</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">radius</span>

    <span class="c1">#=========================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaGeneralizedKirkwoodForce solventDielectric=&quot;78.3&quot; soluteDielectric=&quot;1.0&quot; includeCavityTerm=&quot;1&quot; probeRadius=&quot;0.14&quot; surfaceAreaFactor=&quot;-170.351730663&quot;&gt;</span>
        <span class="c1">#   &lt;GeneralizedKirkwood type=&quot;1&quot; charge=&quot;-0.22620&quot; shct=&quot;0.79&quot;  /&gt;</span>
        <span class="c1">#   &lt;GeneralizedKirkwood type=&quot;2&quot; charge=&quot;-0.15245&quot; shct=&quot;0.72&quot;  /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaGeneralizedKirkwoodGenerator</span><span class="p">(</span><span class="n">forceField</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;solventDielectric&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;soluteDielectric&#39;</span><span class="p">],</span>
                                                        <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;includeCavityTerm&#39;</span><span class="p">],</span>
                                                        <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;probeRadius&#39;</span><span class="p">],</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;surfaceAreaFactor&#39;</span><span class="p">])</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

    <span class="c1">#=========================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">nonbondedMethod</span> <span class="o">!=</span> <span class="n">NoCutoff</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Only the nonbondedMethod=NoCutoff option is available for implicit solvent simulations.&quot;</span> <span class="p">)</span>

        <span class="c1"># check if AmoebaMultipoleForce exists since charges needed</span>
        <span class="c1"># if it has not been created, raise an error</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">amoebaMultipoleForceList</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaMultipoleForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amoebaMultipoleForceList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">amoebaMultipoleForce</span> <span class="o">=</span> <span class="n">amoebaMultipoleForceList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># call AmoebaMultipoleForceGenerator.createForce() to ensure charges have been set</span>

            <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;AmoebaMultipoleGenerator&#39;</span><span class="p">):</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">createForce</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="c1"># get or create force depending on whether it has already been added to the system</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaGeneralizedKirkwoodForce</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaGeneralizedKirkwoodForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;solventDielectric&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSolventDielectric</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;solventDielectric&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSolventDielectric</span><span class="p">(</span>   <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solventDielectric</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;soluteDielectric&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSoluteDielectric</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;soluteDielectric&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSoluteDielectric</span><span class="p">(</span>    <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soluteDielectric</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;includeCavityTerm&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setIncludeCavityTerm</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;includeCavityTerm&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">force</span><span class="o">.</span><span class="n">setIncludeCavityTerm</span><span class="p">(</span>   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">includeCavityTerm</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># add particles to force</span>
        <span class="c1"># throw error if particle type not available</span>

        <span class="n">force</span><span class="o">.</span><span class="n">setProbeRadius</span><span class="p">(</span>         <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probeRadius</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setSurfaceAreaFactor</span><span class="p">(</span>   <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surfaceAreaFactor</span><span class="p">))</span>

        <span class="c1"># 1-2</span>

        <span class="n">bonded12ParticleSets</span> <span class="o">=</span> <span class="n">AmoebaVdwGenerator</span><span class="o">.</span><span class="n">getBondedParticleSets</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">radiusType</span> <span class="o">=</span> <span class="s1">&#39;Bondi&#39;</span>
        <span class="k">for</span> <span class="n">atomIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">amoebaMultipoleForce</span><span class="o">.</span><span class="n">getNumMultipoles</span><span class="p">()):</span>
            <span class="n">multipoleParameters</span> <span class="o">=</span> <span class="n">amoebaMultipoleForce</span><span class="o">.</span><span class="n">getMultipoleParameters</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">radiusType</span> <span class="o">==</span> <span class="s1">&#39;Amoeba&#39;</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAmoebaTypeRadius</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">],</span> <span class="n">atomIndex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBondiTypeRadius</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bonded12ParticleSets</span><span class="p">[</span><span class="n">atomIndex</span><span class="p">],</span> <span class="n">atomIndex</span><span class="p">)</span>
            <span class="c1">#shct = self.getObcShct(data, atomIndex)</span>
            <span class="n">shct</span> <span class="o">=</span> <span class="mf">0.69</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">multipoleParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">shct</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaGeneralizedKirkwoodForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaGeneralizedKirkwoodGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>

<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">AmoebaUreyBradleyGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">#=============================================================================================</span>
    <span class="sd">&quot;&quot;&quot;An AmoebaUreyBradleyGenerator constructs a AmoebaUreyBradleyForce.&quot;&quot;&quot;</span>
    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">types1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types3</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#=============================================================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">forceField</span><span class="p">):</span>

        <span class="c1">#  &lt;AmoebaUreyBradleyForce&gt;</span>
        <span class="c1">#   &lt;UreyBradley class1=&quot;74&quot; class2=&quot;73&quot; class3=&quot;74&quot; k=&quot;16003.8&quot; d=&quot;0.15537&quot; /&gt;</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="n">AmoebaUreyBradleyGenerator</span><span class="p">()</span>
        <span class="n">forceField</span><span class="o">.</span><span class="n">_forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;UreyBradley&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">forceField</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">types1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">types3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">generator</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]))</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputString</span> <span class="o">=</span> <span class="s2">&quot;AmoebaUreyBradleyGenerator: error getting types: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class1&#39;</span><span class="p">],</span> <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class2&#39;</span><span class="p">],</span> <span class="n">bond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class3&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">outputString</span><span class="p">)</span>

    <span class="c1">#=============================================================================================</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getNumForces</span><span class="p">())]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">isConstrained</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">isAngleConstrained</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isConstrained</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexibleConstraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">type3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">)):</span>
                <span class="n">types1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">types3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">type1</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type3</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">type3</span> <span class="ow">in</span> <span class="n">types1</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">types2</span> <span class="ow">and</span> <span class="n">type1</span> <span class="ow">in</span> <span class="n">types3</span><span class="p">)):</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">break</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;AmoebaUreyBradleyForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AmoebaUreyBradleyGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>


<span class="c1">## @private</span>
<span class="k">class</span> <span class="nc">DrudeGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A DrudeGenerator constructs a DrudeForce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcefield</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">forcefield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">_forces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">DrudeGenerator</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">DrudeGenerator</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">registerGenerator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple &lt;DrudeForce&gt; tags were found, probably in different files.  Simply add more types to the existing one.</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Particle&#39;</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">_findAtomTypes</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">aniso12</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">aniso34</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="s1">&#39;aniso12&#39;</span> <span class="ow">in</span> <span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">aniso12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;aniso12&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;aniso34&#39;</span> <span class="ow">in</span> <span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">aniso34</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;aniso34&#39;</span><span class="p">])</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">types</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;polarizability&#39;</span><span class="p">]),</span> <span class="n">aniso12</span><span class="p">,</span> <span class="n">aniso34</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;thole&#39;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">createForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">DrudeForce</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&lt;DrudeForce&gt; must come after &lt;NonbondedForce&gt; in XML file&#39;</span><span class="p">)</span>

        <span class="c1"># Add Drude particles.</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">:</span>
                <span class="c1"># Find other atoms in the residue that affect the Drude particle.</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                    <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">elif</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">elif</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">elif</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">type2</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">excludeAtomWith</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocessSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># For every nonbonded exclusion between Drude particles, add a screened pair.</span>

        <span class="n">drude</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">DrudeForce</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nonbonded</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">particleMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drude</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="n">particleMap</span><span class="p">[</span><span class="n">drude</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbonded</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="p">(</span><span class="n">particle1</span><span class="p">,</span> <span class="n">particle2</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">=</span> <span class="n">nonbonded</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charge</span><span class="o">.</span><span class="n">_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">epsilon</span><span class="o">.</span><span class="n">_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># This is an exclusion.</span>
                <span class="k">if</span> <span class="n">particle1</span> <span class="ow">in</span> <span class="n">particleMap</span> <span class="ow">and</span> <span class="n">particle2</span> <span class="ow">in</span> <span class="n">particleMap</span><span class="p">:</span>
                    <span class="c1"># It connects two Drude particles, so add a screened pair.</span>
                    <span class="n">drude1</span> <span class="o">=</span> <span class="n">particleMap</span><span class="p">[</span><span class="n">particle1</span><span class="p">]</span>
                    <span class="n">drude2</span> <span class="o">=</span> <span class="n">particleMap</span><span class="p">[</span><span class="n">particle2</span><span class="p">]</span>
                    <span class="n">type1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">particle1</span><span class="p">]]</span>
                    <span class="n">type2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomType</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">particle2</span><span class="p">]]</span>
                    <span class="n">thole1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">thole2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeMap</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">drude</span><span class="o">.</span><span class="n">addScreenedPair</span><span class="p">(</span><span class="n">drude1</span><span class="p">,</span> <span class="n">drude2</span><span class="p">,</span> <span class="n">thole1</span><span class="o">+</span><span class="n">thole2</span><span class="p">)</span>

<span class="n">parsers</span><span class="p">[</span><span class="s2">&quot;DrudeForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DrudeGenerator</span><span class="o">.</span><span class="n">parseElement</span>

<span class="c1">#=============================================================================================</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2018, Vanderbilt University

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>